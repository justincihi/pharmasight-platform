<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PharmaSight‚Ñ¢ - Advanced Drug Discovery Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.98);
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
        }

        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
        }

        .nav-links {
            display: flex;
            gap: 2rem;
            list-style: none;
        }

        .nav-link {
            color: #555;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
            cursor: pointer;
        }

        .nav-link:hover, .nav-link.active {
            color: #667eea;
        }

        /* Main Content */
        .main-content {
            margin-top: 80px;
            padding: 2rem;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
        }

        /* Hero Section */
        .hero {
            background: white;
            border-radius: 20px;
            padding: 3rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            text-align: center;
        }

        .hero h1 {
            font-size: 48px;
            color: #333;
            margin-bottom: 1rem;
        }

        .hero .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .hero p {
            font-size: 20px;
            color: #666;
            margin-bottom: 2rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 2rem;
            margin-top: 3rem;
        }

        .stat-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 1.5rem;
            border-radius: 15px;
            text-align: center;
        }

        .stat-value {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 0.5rem;
        }

        /* Feature Cards */
        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .feature-card {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
        }

        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        }

        .feature-card .icon {
            font-size: 48px;
            margin-bottom: 1rem;
        }

        .feature-card h3 {
            color: #333;
            margin-bottom: 1rem;
            font-size: 24px;
        }

        .feature-card p {
            color: #666;
            line-height: 1.6;
            margin-bottom: 1.5rem;
        }

        .feature-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.3s;
        }

        .feature-btn:hover {
            opacity: 0.9;
        }

        /* Sections (hidden by default) */
        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* Analysis Section */
        .analysis-container {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .input-group {
            margin-bottom: 1.5rem;
        }

        .input-group label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 0.5rem;
        }

        .input-group input,
        .input-group textarea,
        .input-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input-group input:focus,
        .input-group textarea:focus,
        .input-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 32px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.3s;
            width: 100%;
        }

        .btn-primary:hover {
            opacity: 0.9;
        }

        /* Results */
        .results-container {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 2rem;
            margin-top: 2rem;
            max-height: 500px;
            overflow-y: auto;
        }

        .result-item {
            background: white;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            border-left: 4px solid #667eea;
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid #e1e8ed;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            color: #666;
            font-weight: 500;
            cursor: pointer;
            transition: color 0.3s;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .close-btn {
            font-size: 28px;
            color: #999;
            cursor: pointer;
            background: none;
            border: none;
        }

        .close-btn:hover {
            color: #333;
        }

        /* Success/Error Messages */
        .message {
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .features-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-links {
                display: none;
            }

            .hero h1 {
                font-size: 32px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <nav class="nav-container">
            <div class="logo">
                <span>üíä</span>
                <span>PharmaSight‚Ñ¢</span>
            </div>
            <ul class="nav-links">
                <li><a class="nav-link active" onclick="showSection('home')">Dashboard</a></li>
                <li><a class="nav-link" onclick="showSection('screening')">Screening</a></li>
                <li><a class="nav-link" onclick="showSection('retrosynthesis')">Retrosynthesis</a></li>
                <li><a class="nav-link" onclick="showSection('research')">Research Engine</a></li>
                <li><a class="nav-link" onclick="showSection('analogs')">Analogs/IP</a></li>
                <li><a class="nav-link" onclick="showSection('pkpd')">PKPD</a></li>
                <li><a class="nav-link" onclick="showSection('ddi')">DDI</a></li>
                <li><a class="nav-link" onclick="showSection('analysis')">Analysis</a></li>
            </ul>
            <div class="nav-user" style="display: flex; align-items: center; gap: 10px;">
                <button onclick="showSection('login')" style="background: transparent; border: 1px solid #667eea; color: #667eea; padding: 6px 16px; border-radius: 20px; cursor: pointer;">Login</button>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Home Section -->
        <div id="home" class="section active">
            <div class="hero">
                <h1>Welcome to <span class="gradient-text">PharmaSight‚Ñ¢</span></h1>
                <p>Enterprise-Grade AI-Powered Drug Discovery Platform</p>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">82</div>
                        <div class="stat-label">Receptor Targets</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">500+</div>
                        <div class="stat-label">Compounds</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">7</div>
                        <div class="stat-label">AI Modules</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">10K√ó</div>
                        <div class="stat-label">Quantum Speedup</div>
                    </div>
                </div>
            </div>

            <div class="features-grid">
                <div class="feature-card" onclick="showSection('screening')">
                    <div class="icon">üî¨</div>
                    <h3>Virtual Screening</h3>
                    <p>Screen compounds against 82 receptor targets simultaneously using our advanced vHTS pipeline.</p>
                    <button class="feature-btn">Start Screening</button>
                </div>

                <div class="feature-card" onclick="showSection('optimization')">
                    <div class="icon">üß¨</div>
                    <h3>Lead Optimization</h3>
                    <p>AI-powered molecular modifications to improve binding affinity and drug-likeness.</p>
                    <button class="feature-btn">Optimize Leads</button>
                </div>

                <div class="feature-card" onclick="showSection('safety')">
                    <div class="icon">‚ö†Ô∏è</div>
                    <h3>Safety Prediction</h3>
                    <p>Predict off-targets, side effects, and drug-drug interactions before synthesis.</p>
                    <button class="feature-btn">Check Safety</button>
                </div>

                <div class="feature-card" onclick="showSection('analysis')">
                    <div class="icon">üìä</div>
                    <h3>Compound Analysis</h3>
                    <p>Comprehensive molecular analysis with RDKit integration and property calculation.</p>
                    <button class="feature-btn">Analyze Compound</button>
                </div>

                <div class="feature-card" onclick="showSection('pkpd')">
                    <div class="icon">üìâ</div>
                    <h3>PKPD/PBPK Modeling</h3>
                    <p>Pharmacokinetic/pharmacodynamic simulations with population analysis and concentration curves.</p>
                    <button class="feature-btn">Run PK Simulation</button>
                </div>

                <div class="feature-card" onclick="showSection('ddi')">
                    <div class="icon">üíä</div>
                    <h3>DDI Scanner</h3>
                    <p>Drug-drug interaction analysis with CYP450 enzyme predictions and risk assessment.</p>
                    <button class="feature-btn">Scan Interactions</button>
                </div>

                <div class="feature-card" onclick="showSection('analogs')">
                    <div class="icon">üîì</div>
                    <h3>Patent-Free Analogs</h3>
                    <p>Generate high-confidence analogs with IP opportunity scoring and patent status analysis.</p>
                    <button class="feature-btn">Find Analogs</button>
                </div>

                <div class="feature-card" onclick="showSection('sar')">
                    <div class="icon">üìà</div>
                    <h3>SAR Explorer</h3>
                    <p>Visualize structure-activity relationships and identify activity cliffs.</p>
                    <button class="feature-btn">Explore SAR</button>
                </div>

                <div class="feature-card" onclick="showSection('quantum')">
                    <div class="icon">‚öõÔ∏è</div>
                    <h3>Quantum Computing</h3>
                    <p>Leverage quantum algorithms for protein folding and molecular dynamics.</p>
                    <button class="feature-btn">Quantum Simulation</button>
                </div>
            </div>
        </div>

        <!-- Virtual Screening Section -->
        <div id="screening" class="section">
            <div class="analysis-container">
                <h2>üî¨ Virtual High-Throughput Screening</h2>
                <p style="color: #666; margin-bottom: 2rem;">Screen your compounds against all 82 receptor targets</p>
                
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('screening', 'single')">Single Compound</button>
                    <button class="tab" onclick="switchTab('screening', 'batch')">Batch Screening</button>
                </div>

                <div id="screening-single" class="tab-content active">
                    <div class="input-group">
                        <label>SMILES String</label>
                        <input type="text" id="vhts-smiles" placeholder="e.g., CN1CCC[C@H]1c2cccnc2" value="CN1CCC[C@H]1c2cccnc2">
                    </div>
                    
                    <div class="input-group">
                        <label>Compound Name (Optional)</label>
                        <input type="text" id="vhts-name" placeholder="Enter compound name">
                    </div>
                    
                    <button class="btn-primary" onclick="runVirtualScreening()">Run Screening</button>
                </div>

                <div id="screening-batch" class="tab-content">
                    <div class="input-group">
                        <label>Compound List (JSON Format)</label>
                        <textarea id="batch-compounds" rows="6" placeholder='[{"smiles": "...", "name": "..."}, ...]'>[
  {"smiles": "CN1CCC[C@H]1c2cccnc2", "name": "Nicotine"},
  {"smiles": "CC(C)NCC(O)COc1ccccc1", "name": "Propranolol"},
  {"smiles": "O=C(C)Oc1ccccc1C(=O)O", "name": "Aspirin"}
]</textarea>
                    </div>
                    
                    <button class="btn-primary" onclick="runBatchScreening()">Run Batch Screening</button>
                </div>

                <div id="screening-loading" class="loading">
                    <div class="spinner"></div>
                    <p>Screening against 82 receptor targets...</p>
                </div>

                <div id="screening-results" class="results-container" style="display: none;"></div>
            </div>
        </div>

        <!-- Lead Optimization Section -->
        <div id="optimization" class="section">
            <div class="analysis-container">
                <h2>üß¨ AI-Powered Lead Optimization</h2>
                <p style="color: #666; margin-bottom: 2rem;">Generate optimized molecular modifications using machine learning</p>
                
                <div class="input-group">
                    <label>Lead Compound SMILES</label>
                    <input type="text" id="opt-smiles" placeholder="Enter SMILES string" value="Cc1ccc(cc1Nc2nccc(n2)c3cccnc3)NC(=O)c4ccc(cc4)CN5CCN(CC5)C">
                </div>
                
                <div class="input-group">
                    <label>Optimization Goals</label>
                    <select id="opt-goals" multiple style="height: 100px;">
                        <option value="potency" selected>Improve Potency</option>
                        <option value="selectivity">Improve Selectivity</option>
                        <option value="solubility">Improve Solubility</option>
                        <option value="stability">Metabolic Stability</option>
                        <option value="toxicity">Reduce Toxicity</option>
                    </select>
                    <small style="color: #666;">Hold Ctrl/Cmd to select multiple</small>
                </div>
                
                <button class="btn-primary" onclick="optimizeLead()">Generate Optimizations</button>
                
                <div id="opt-loading" class="loading">
                    <div class="spinner"></div>
                    <p>Generating optimization strategies...</p>
                </div>

                <div id="opt-results" class="results-container" style="display: none;"></div>
            </div>
        </div>

        <!-- Safety Prediction Section -->
        <div id="safety" class="section">
            <div class="analysis-container">
                <h2>‚ö†Ô∏è Off-Target & Safety Prediction</h2>
                <p style="color: #666; margin-bottom: 2rem;">Predict potential side effects and safety liabilities</p>
                
                <div class="input-group">
                    <label>Compound SMILES</label>
                    <input type="text" id="safety-smiles" placeholder="Enter SMILES string" value="O=C(C)Oc1ccccc1C(=O)O">
                </div>
                
                <div class="input-group">
                    <label>Primary Target (Optional)</label>
                    <input type="text" id="safety-target" placeholder="e.g., COX-2, 5-HT2A, D2" value="COX-2">
                </div>
                
                <button class="btn-primary" onclick="predictSafety()">Predict Safety Profile</button>
                
                <div id="safety-loading" class="loading">
                    <div class="spinner"></div>
                    <p>Analyzing safety profile...</p>
                </div>

                <div id="safety-results" class="results-container" style="display: none;"></div>
            </div>
        </div>

        <!-- Compound Analysis Section -->
        <div id="analysis" class="section">
            <div class="analysis-container">
                <h2>üìä Compound Analysis</h2>
                <p style="color: #666; margin-bottom: 2rem;">Comprehensive molecular analysis and visualization</p>
                
                <div class="input-group">
                    <label>Compound Name or SMILES</label>
                    <input type="text" id="analysis-input" placeholder="e.g., Aspirin, Caffeine, or SMILES" value="Caffeine">
                </div>
                
                <button class="btn-primary" onclick="analyzeCompound()">Analyze Compound</button>
                
                <div id="analysis-loading" class="loading">
                    <div class="spinner"></div>
                    <p>Analyzing compound...</p>
                </div>

                <div id="analysis-results" class="results-container" style="display: none;"></div>
            </div>
        </div>

        <!-- SAR Explorer Section -->
        <div id="sar" class="section">
            <div class="analysis-container">
                <h2>üìà Structure-Activity Relationship Explorer</h2>
                <p style="color: #666; margin-bottom: 2rem;">Analyze SAR patterns and activity cliffs</p>
                
                <div class="input-group">
                    <label>Compound Series (JSON Format)</label>
                    <textarea id="sar-compounds" rows="8" placeholder='[{"smiles": "...", "activity": 0.8, "id": "CPD1"}, ...]'>[
  {"smiles": "CC(C)NCC(O)COc1ccccc1", "activity": 0.75, "id": "CPD1"},
  {"smiles": "CC(C)NCC(O)COc1ccccc1F", "activity": 0.85, "id": "CPD2"},
  {"smiles": "CC(C)NCC(O)COc1ccccc1Cl", "activity": 0.65, "id": "CPD3"},
  {"smiles": "CC(C)NCC(O)COc1ccc(OC)cc1", "activity": 0.90, "id": "CPD4"}
]</textarea>
                </div>
                
                <button class="btn-primary" onclick="analyzeSAR()">Analyze SAR</button>
                
                <div id="sar-loading" class="loading">
                    <div class="spinner"></div>
                    <p>Analyzing structure-activity relationships...</p>
                </div>

                <div id="sar-results" class="results-container" style="display: none;"></div>
            </div>
        </div>

        <!-- Quantum Computing Section -->
        <div id="quantum" class="section">
            <div class="analysis-container">
                <h2>‚öõÔ∏è Quantum Computing Simulations</h2>
                <p style="color: #666; margin-bottom: 2rem;">Harness quantum algorithms for advanced molecular simulations</p>
                
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('quantum', 'folding')">Protein Folding</button>
                    <button class="tab" onclick="switchTab('quantum', 'dynamics')">Molecular Dynamics</button>
                    <button class="tab" onclick="switchTab('quantum', 'qopt')">Lead Optimization</button>
                </div>

                <div id="quantum-folding" class="tab-content active">
                    <div class="input-group">
                        <label>Protein Sequence</label>
                        <input type="text" id="protein-seq" placeholder="Enter amino acid sequence" value="MKALVLIALLVA">
                    </div>
                    <button class="btn-primary" onclick="simulateProteinFolding()">Simulate Folding</button>
                </div>

                <div id="quantum-dynamics" class="tab-content">
                    <div class="input-group">
                        <label>Molecule SMILES</label>
                        <input type="text" id="qmd-smiles" placeholder="Enter SMILES" value="CC(C)NCC(O)COc1ccccc1">
                    </div>
                    <div class="input-group">
                        <label>Target Protein</label>
                        <input type="text" id="qmd-target" placeholder="e.g., 5-HT2A, D2" value="5-HT2A">
                    </div>
                    <button class="btn-primary" onclick="runQuantumMD()">Run Quantum MD</button>
                </div>

                <div id="quantum-qopt" class="tab-content">
                    <div class="input-group">
                        <label>Lead Compound SMILES</label>
                        <input type="text" id="qopt-smiles" placeholder="Enter SMILES" value="Cc1ccc(cc1)NC(=O)c2ccccc2">
                    </div>
                    <button class="btn-primary" onclick="quantumOptimize()">Quantum Optimize</button>
                </div>
                
                <div id="quantum-loading" class="loading">
                    <div class="spinner"></div>
                    <p>Running quantum simulation...</p>
                </div>

                <div id="quantum-results" class="results-container" style="display: none;"></div>
            </div>
        </div>

        <!-- PKPD/PBPK Modeling Section -->
        <div id="pkpd" class="section">
            <div class="analysis-container">
                <h2>üìâ PKPD/PBPK Modeling</h2>
                <p style="color: #666; margin-bottom: 2rem;">Simulate pharmacokinetic profiles and analyze drug behavior across patient populations</p>
                
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('pkpd', 'single')">Single Patient</button>
                    <button class="tab" onclick="switchTab('pkpd', 'population')">Population PK</button>
                    <button class="tab" onclick="switchTab('pkpd', 'pbpk')">PBPK Model</button>
                </div>

                <div id="pkpd-single" class="tab-content active">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                        <div>
                            <h4 style="margin-bottom: 1rem; color: #667eea;">Drug Parameters</h4>
                            <div class="input-group">
                                <label>Drug Name / SMILES</label>
                                <input type="text" id="pkpd-drug" placeholder="e.g., Ibuprofen or SMILES" value="Ibuprofen">
                            </div>
                            <div class="input-group">
                                <label>Dose (mg)</label>
                                <input type="number" id="pkpd-dose" placeholder="e.g., 400" value="400">
                            </div>
                            <div class="input-group">
                                <label>Clearance (L/h)</label>
                                <input type="number" id="pkpd-clearance" placeholder="e.g., 10" value="10" step="0.1">
                            </div>
                            <div class="input-group">
                                <label>Volume of Distribution (L)</label>
                                <input type="number" id="pkpd-vd" placeholder="e.g., 50" value="50">
                            </div>
                            <div class="input-group">
                                <label>Absorption Rate (1/h)</label>
                                <input type="number" id="pkpd-ka" placeholder="e.g., 1.0" value="1.0" step="0.1">
                            </div>
                        </div>
                        <div>
                            <h4 style="margin-bottom: 1rem; color: #667eea;">Patient Parameters</h4>
                            <div class="input-group">
                                <label>Age (years)</label>
                                <input type="number" id="pkpd-age" placeholder="e.g., 45" value="45">
                            </div>
                            <div class="input-group">
                                <label>Weight (kg)</label>
                                <input type="number" id="pkpd-weight" placeholder="e.g., 70" value="70">
                            </div>
                            <div class="input-group">
                                <label>Liver Function (0-1)</label>
                                <input type="number" id="pkpd-liver" placeholder="1.0 = normal" value="1.0" step="0.1" min="0" max="1">
                            </div>
                            <div class="input-group">
                                <label>Creatinine Clearance (mL/min)</label>
                                <input type="number" id="pkpd-creatinine" placeholder="e.g., 100" value="100">
                            </div>
                            <div class="input-group">
                                <label>PK Model</label>
                                <select id="pkpd-model">
                                    <option value="one_compartment">One-Compartment</option>
                                    <option value="two_compartment">Two-Compartment</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <button class="btn-primary" onclick="runPKPDSimulation()">Run PK Simulation</button>
                </div>

                <div id="pkpd-population" class="tab-content">
                    <div class="input-group">
                        <label>Drug Name / SMILES</label>
                        <input type="text" id="pop-drug" placeholder="e.g., Metformin" value="Metformin">
                    </div>
                    <div class="input-group">
                        <label>Dose (mg)</label>
                        <input type="number" id="pop-dose" placeholder="e.g., 500" value="500">
                    </div>
                    <div class="input-group">
                        <label>Population Size</label>
                        <input type="number" id="pop-size" placeholder="e.g., 100" value="100" min="10" max="1000">
                    </div>
                    <div class="input-group">
                        <label>Age Range</label>
                        <div style="display: flex; gap: 1rem;">
                            <input type="number" id="pop-age-min" placeholder="Min" value="18" style="width: 50%;">
                            <input type="number" id="pop-age-max" placeholder="Max" value="75" style="width: 50%;">
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Include Conditions</label>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            <label><input type="checkbox" id="pop-hepatic" checked> Hepatic Impairment</label>
                            <label><input type="checkbox" id="pop-renal" checked> Renal Impairment</label>
                            <label><input type="checkbox" id="pop-elderly" checked> Elderly (>65)</label>
                        </div>
                    </div>
                    <button class="btn-primary" onclick="runPopulationPK()">Run Population Analysis</button>
                </div>

                <div id="pkpd-pbpk" class="tab-content">
                    <div class="input-group">
                        <label>Drug Name / SMILES</label>
                        <input type="text" id="pbpk-drug" placeholder="e.g., Atorvastatin or SMILES" value="CC(C)c1c(C(=O)Nc2ccccc2)c(c(c3ccc(F)cc3)n1CC[C@@H](O)C[C@@H](O)CC(=O)O)c4ccccc4">
                    </div>
                    <div class="input-group">
                        <label>Dose (mg)</label>
                        <input type="number" id="pbpk-dose" placeholder="e.g., 20" value="20">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="input-group">
                            <label>LogP (Lipophilicity)</label>
                            <input type="number" id="pbpk-logp" placeholder="e.g., 4.5" value="4.5" step="0.1">
                        </div>
                        <div class="input-group">
                            <label>Fraction Unbound</label>
                            <input type="number" id="pbpk-fu" placeholder="e.g., 0.02" value="0.02" step="0.01" min="0" max="1">
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Target Organs</label>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            <label><input type="checkbox" id="pbpk-liver" checked> Liver</label>
                            <label><input type="checkbox" id="pbpk-kidney" checked> Kidney</label>
                            <label><input type="checkbox" id="pbpk-brain"> Brain</label>
                            <label><input type="checkbox" id="pbpk-heart" checked> Heart</label>
                            <label><input type="checkbox" id="pbpk-muscle"> Muscle</label>
                        </div>
                    </div>
                    <button class="btn-primary" onclick="runPBPKSimulation()">Run PBPK Model</button>
                </div>
                
                <div id="pkpd-loading" class="loading">
                    <div class="spinner"></div>
                    <p>Running pharmacokinetic simulation...</p>
                </div>

                <div id="pkpd-results" class="results-container" style="display: none;"></div>
            </div>
        </div>

        <!-- DDI Scanner Section -->
        <div id="ddi" class="section">
            <div class="analysis-container">
                <h2>üíä Drug-Drug Interaction Scanner</h2>
                <p style="color: #666; margin-bottom: 2rem;">Analyze drug combinations for interactions, CYP450 effects, and safety risks</p>
                
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('ddi', 'pair')">Drug Pair</button>
                    <button class="tab" onclick="switchTab('ddi', 'cyp')">CYP450 Profile</button>
                    <button class="tab" onclick="switchTab('ddi', 'cocktail')">Drug Cocktail</button>
                </div>

                <div id="ddi-pair" class="tab-content active">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                        <div class="input-group">
                            <label>Drug 1</label>
                            <input type="text" id="ddi-drug1" placeholder="e.g., Sertraline" value="Sertraline">
                        </div>
                        <div class="input-group">
                            <label>Drug 2</label>
                            <input type="text" id="ddi-drug2" placeholder="e.g., Tramadol" value="Tramadol">
                        </div>
                    </div>
                    <button class="btn-primary" onclick="scanDDIPair()">Analyze Interaction</button>
                </div>

                <div id="ddi-cyp" class="tab-content">
                    <div class="input-group">
                        <label>Compound (Name or SMILES)</label>
                        <input type="text" id="cyp-compound" placeholder="e.g., Fluoxetine or SMILES" value="Fluoxetine">
                    </div>
                    <div class="input-group">
                        <label>CYP Enzymes to Analyze</label>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            <label><input type="checkbox" id="cyp-3a4" checked> CYP3A4</label>
                            <label><input type="checkbox" id="cyp-2d6" checked> CYP2D6</label>
                            <label><input type="checkbox" id="cyp-2c9" checked> CYP2C9</label>
                            <label><input type="checkbox" id="cyp-2c19" checked> CYP2C19</label>
                            <label><input type="checkbox" id="cyp-1a2" checked> CYP1A2</label>
                        </div>
                    </div>
                    <button class="btn-primary" onclick="analyzeCYPProfile()">Analyze CYP450 Profile</button>
                </div>

                <div id="ddi-cocktail" class="tab-content">
                    <div class="input-group">
                        <label>Drug List (one per line)</label>
                        <textarea id="cocktail-drugs" rows="6" placeholder="Enter drug names, one per line">Sertraline
Alprazolam
Ibuprofen
Omeprazole</textarea>
                    </div>
                    <div class="input-group">
                        <label>Patient Conditions</label>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            <label><input type="checkbox" id="cocktail-liver"> Liver Disease</label>
                            <label><input type="checkbox" id="cocktail-kidney"> Kidney Disease</label>
                            <label><input type="checkbox" id="cocktail-elderly"> Elderly (>65)</label>
                            <label><input type="checkbox" id="cocktail-pregnant"> Pregnancy</label>
                        </div>
                    </div>
                    <button class="btn-primary" onclick="analyzeDrugCocktail()">Analyze Cocktail Safety</button>
                </div>
                
                <div id="ddi-loading" class="loading">
                    <div class="spinner"></div>
                    <p>Analyzing drug interactions...</p>
                </div>

                <div id="ddi-results" class="results-container" style="display: none;"></div>
            </div>
        </div>

        <!-- Patent-Free Analog Generation Section -->
        <div id="analogs" class="section">
            <div class="analysis-container">
                <h2>üîì Patent-Free Analog Generation</h2>
                <p style="color: #666; margin-bottom: 2rem;">Generate high-confidence analogs with IP opportunity scoring and freedom-to-operate analysis</p>
                
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('analogs', 'generate')">Generate Analogs</button>
                    <button class="tab" onclick="switchTab('analogs', 'ip')">IP Analysis</button>
                    <button class="tab" onclick="switchTab('analogs', 'database')">Database Search</button>
                </div>

                <div id="analogs-generate" class="tab-content active">
                    <div class="input-group">
                        <label>Parent Compound (Name or SMILES)</label>
                        <input type="text" id="analog-parent" placeholder="e.g., Psilocybin, Ketamine, or SMILES" value="Psilocybin">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="input-group">
                            <label>Minimum Similarity</label>
                            <input type="number" id="analog-similarity" placeholder="e.g., 0.7" value="0.7" step="0.05" min="0.5" max="0.99">
                        </div>
                        <div class="input-group">
                            <label>Number of Analogs</label>
                            <input type="number" id="analog-count" placeholder="e.g., 10" value="10" min="1" max="50">
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Patent Status Filter</label>
                        <select id="analog-patent-filter">
                            <option value="all">All Analogs</option>
                            <option value="patent_free" selected>Patent-Free Only</option>
                            <option value="expired">Patent Expired</option>
                            <option value="pending">Patent Pending</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Optimization Targets</label>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            <label><input type="checkbox" id="analog-efficacy" checked> Efficacy</label>
                            <label><input type="checkbox" id="analog-safety" checked> Safety</label>
                            <label><input type="checkbox" id="analog-druglike" checked> Drug-Likeness</label>
                            <label><input type="checkbox" id="analog-novelty" checked> Novelty</label>
                        </div>
                    </div>
                    <button class="btn-primary" onclick="generatePatentFreeAnalogs()">Generate Patent-Free Analogs</button>
                </div>

                <div id="analogs-ip" class="tab-content">
                    <div class="input-group">
                        <label>Compound SMILES</label>
                        <input type="text" id="ip-smiles" placeholder="Enter SMILES for IP analysis" value="CN(C)CCc1c[nH]c2ccc(OP(=O)(O)O)cc12">
                    </div>
                    <button class="btn-primary" onclick="analyzeIPOpportunity()">Analyze IP Opportunity</button>
                </div>

                <div id="analogs-database" class="tab-content">
                    <div class="input-group">
                        <label>Search Term (Name or SMILES)</label>
                        <input type="text" id="db-search" placeholder="e.g., Ketamine, Aspirin" value="Ketamine">
                    </div>
                    <div class="input-group">
                        <label>External Databases</label>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            <label><input type="checkbox" id="db-pubchem" checked> PubChem</label>
                            <label><input type="checkbox" id="db-chembl" checked> ChEMBL</label>
                            <label><input type="checkbox" id="db-fda" checked> FDA Orange Book</label>
                            <label><input type="checkbox" id="db-internal" checked> Internal Database</label>
                        </div>
                    </div>
                    <button class="btn-primary" onclick="searchDatabases()">Search Databases</button>
                </div>
                
                <div id="analogs-loading" class="loading">
                    <div class="spinner"></div>
                    <p>Generating patent-free analogs...</p>
                </div>

                <div id="analogs-results" class="results-container" style="display: none;"></div>
            </div>
        </div>

        <!-- Retrosynthesis Planning Section -->
        <div id="retrosynthesis" class="section">
            <div class="section-header">
                <h2>Retrosynthesis Planning</h2>
                <p>AI-powered synthetic route analysis and complexity assessment</p>
            </div>
            
            <div class="card">
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('retrosynthesis', 'retro-analyze', event)">Route Analysis</button>
                    <button class="tab" onclick="switchTab('retrosynthesis', 'retro-complexity', event)">Complexity Score</button>
                    <button class="tab" onclick="switchTab('retrosynthesis', 'retro-building-blocks', event)">Building Blocks</button>
                </div>

                <div id="retro-analyze" class="tab-content active">
                    <div class="input-group">
                        <label>Compound SMILES or Name</label>
                        <input type="text" id="retro-compound" placeholder="e.g., Psilocybin or CN(C)CCc1c[nH]c2ccc(OP(=O)(O)O)cc12" value="Psilocybin">
                    </div>
                    <div class="input-group">
                        <label>Max Synthesis Steps</label>
                        <input type="number" id="retro-max-steps" value="6" min="2" max="12">
                    </div>
                    <button class="btn-primary" onclick="analyzeRetrosynthesis()">Analyze Synthetic Routes</button>
                </div>

                <div id="retro-complexity" class="tab-content">
                    <div class="input-group">
                        <label>Compound SMILES</label>
                        <input type="text" id="retro-complexity-smiles" placeholder="Enter SMILES" value="CN(C)CCc1c[nH]c2ccc(OP(=O)(O)O)cc12">
                    </div>
                    <button class="btn-primary" onclick="calculateComplexity()">Calculate Complexity</button>
                </div>

                <div id="retro-building-blocks" class="tab-content">
                    <div class="input-group">
                        <label>Target Compound SMILES</label>
                        <input type="text" id="retro-target-smiles" placeholder="Enter SMILES" value="c1ccc(N)cc1">
                    </div>
                    <button class="btn-primary" onclick="findBuildingBlocks()">Find Building Blocks</button>
                </div>
                
                <div id="retro-loading" class="loading">
                    <div class="spinner"></div>
                    <p>Analyzing synthetic routes...</p>
                </div>

                <div id="retro-results" class="results-container" style="display: none;"></div>
            </div>
        </div>

        <!-- Autonomous Research Engine Section -->
        <div id="research" class="section">
            <div class="section-header">
                <h2>24/7 Autonomous Research Engine</h2>
                <p>AI-driven literature scanning, compound discovery, and research goal tracking</p>
            </div>
            
            <div class="card">
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('research', 'research-goals', event)">Research Goals</button>
                    <button class="tab" onclick="switchTab('research', 'research-discoveries', event)">Daily Discoveries</button>
                    <button class="tab" onclick="switchTab('research', 'research-literature', event)">Literature Scan</button>
                    <button class="tab" onclick="switchTab('research', 'research-registry', event)">Analog Registry</button>
                </div>

                <div id="research-goals" class="tab-content active">
                    <div style="margin-bottom: 1rem;">
                        <h4 style="display: flex; justify-content: space-between; align-items: center;">
                            Active Research Goals
                            <button class="btn-secondary" onclick="addResearchGoal()" style="font-size: 12px; padding: 6px 12px;">+ Add Goal</button>
                        </h4>
                    </div>
                    <div id="goals-list">
                        <div class="result-item" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <div>
                                <strong>Novel 5-HT2A Agonists</strong>
                                <p style="font-size: 12px; color: #666; margin: 0;">Find patent-free psychedelic analogs with therapeutic potential</p>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <span style="background: #28a745; color: white; padding: 3px 10px; border-radius: 10px; font-size: 11px;">Active</span>
                                <button onclick="editGoal(0)" style="background: #667eea; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">Edit</button>
                            </div>
                        </div>
                        <div class="result-item" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <div>
                                <strong>GABA Receptor Modulators</strong>
                                <p style="font-size: 12px; color: #666; margin: 0;">Identify novel anxiolytics with improved safety profiles</p>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <span style="background: #28a745; color: white; padding: 3px 10px; border-radius: 10px; font-size: 11px;">Active</span>
                                <button onclick="editGoal(1)" style="background: #667eea; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">Edit</button>
                            </div>
                        </div>
                        <div class="result-item" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <div>
                                <strong>NMDA Receptor Research</strong>
                                <p style="font-size: 12px; color: #666; margin: 0;">Track ketamine-related developments and novel dissociatives</p>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <span style="background: #ffc107; color: #333; padding: 3px 10px; border-radius: 10px; font-size: 11px;">Paused</span>
                                <button onclick="editGoal(2)" style="background: #667eea; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">Edit</button>
                            </div>
                        </div>
                    </div>
                    <button class="btn-primary" onclick="runResearchEngine()" style="margin-top: 1rem;">Run Research Scan Now</button>
                </div>

                <div id="research-discoveries" class="tab-content">
                    <div class="input-group">
                        <label>Discovery Date Range</label>
                        <div style="display: flex; gap: 1rem;">
                            <input type="date" id="discovery-start" value="2025-11-01">
                            <input type="date" id="discovery-end" value="2025-11-26">
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Filter by Type</label>
                        <select id="discovery-type">
                            <option value="all">All Discoveries</option>
                            <option value="high_value">High Value (>$10M)</option>
                            <option value="patent_free">Patent-Free</option>
                            <option value="breakthrough">Breakthrough Candidates</option>
                        </select>
                    </div>
                    <button class="btn-primary" onclick="fetchDailyDiscoveries()">Load Discoveries</button>
                </div>

                <div id="research-literature" class="tab-content">
                    <div class="input-group">
                        <label>Search Topic</label>
                        <input type="text" id="lit-search-topic" placeholder="e.g., psilocybin treatment-resistant depression" value="psilocybin depression">
                    </div>
                    <div class="input-group">
                        <label>Publication Year Range</label>
                        <div style="display: flex; gap: 1rem;">
                            <input type="number" id="lit-year-start" value="2023" min="2000" max="2025">
                            <input type="number" id="lit-year-end" value="2025" min="2000" max="2025">
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Sources</label>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            <label><input type="checkbox" id="lit-pubmed" checked> PubMed</label>
                            <label><input type="checkbox" id="lit-biorxiv" checked> bioRxiv</label>
                            <label><input type="checkbox" id="lit-patents" checked> Patents</label>
                            <label><input type="checkbox" id="lit-clintrials" checked> Clinical Trials</label>
                        </div>
                    </div>
                    <button class="btn-primary" onclick="scanLiterature()">Scan Literature</button>
                </div>

                <div id="research-registry" class="tab-content">
                    <div style="background: linear-gradient(135deg, #667eea20 0%, #764ba220 100%); padding: 1.5rem; border-radius: 10px; margin-bottom: 1rem;">
                        <h4 style="margin: 0 0 0.5rem 0;">Public Analog Registry</h4>
                        <p style="margin: 0; font-size: 14px; color: #666;">Track all analogs generated by PharmaSight. Synced with your GitHub repository.</p>
                    </div>
                    <div id="registry-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                        <div class="stat-card" style="text-align: center;">
                            <div style="font-size: 28px; color: #667eea; font-weight: bold;" id="registry-total">247</div>
                            <small>Total Analogs</small>
                        </div>
                        <div class="stat-card" style="text-align: center;">
                            <div style="font-size: 28px; color: #28a745; font-weight: bold;" id="registry-patent-free">189</div>
                            <small>Patent-Free</small>
                        </div>
                        <div class="stat-card" style="text-align: center;">
                            <div style="font-size: 28px; color: #764ba2; font-weight: bold;" id="registry-high-value">42</div>
                            <small>High Value</small>
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Search Registry</label>
                        <input type="text" id="registry-search" placeholder="Search by name, SMILES, or therapeutic area">
                    </div>
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn-primary" onclick="searchRegistry()">Search Registry</button>
                        <button class="btn-secondary" onclick="syncRegistry()">Sync with GitHub</button>
                    </div>
                </div>
                
                <div id="research-loading" class="loading">
                    <div class="spinner"></div>
                    <p>Running autonomous research scan...</p>
                </div>

                <div id="research-results" class="results-container" style="display: none;"></div>
            </div>
        </div>

        <!-- Login Section -->
        <div id="login" class="section">
            <div style="max-width: 400px; margin: 0 auto;">
                <div class="card" style="text-align: center;">
                    <div style="margin-bottom: 1.5rem;">
                        <span style="font-size: 48px;">üíä</span>
                        <h2 style="margin: 0.5rem 0;">PharmaSight‚Ñ¢</h2>
                        <p style="color: #666; margin: 0;">Enterprise Drug Discovery Platform</p>
                    </div>
                    
                    <div id="login-form">
                        <div class="input-group">
                            <label style="text-align: left;">Username</label>
                            <input type="text" id="login-username" placeholder="Enter username">
                        </div>
                        <div class="input-group">
                            <label style="text-align: left;">Password</label>
                            <input type="password" id="login-password" placeholder="Enter password">
                        </div>
                        <div class="input-group" style="display: flex; justify-content: space-between; align-items: center;">
                            <label style="font-size: 12px;"><input type="checkbox" id="login-remember"> Remember me</label>
                            <a href="#" style="font-size: 12px; color: #667eea;">Forgot password?</a>
                        </div>
                        <button class="btn-primary" onclick="performLogin()" style="width: 100%; margin-top: 1rem;">Sign In</button>
                        
                        <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #eee;">
                            <p style="color: #666; font-size: 12px; margin-bottom: 1rem;">Administrator access</p>
                            <button class="btn-secondary" onclick="showAdminLogin()" style="width: 100%;">Admin Login</button>
                        </div>
                    </div>
                    
                    <div id="admin-login-form" style="display: none;">
                        <div style="background: #fff3cd; padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem;">
                            <small style="color: #856404;">Restricted access for system administrators only</small>
                        </div>
                        <div class="input-group">
                            <label style="text-align: left;">Admin Username</label>
                            <input type="text" id="admin-username" placeholder="Admin username">
                        </div>
                        <div class="input-group">
                            <label style="text-align: left;">Admin Password</label>
                            <input type="password" id="admin-password" placeholder="Admin password">
                        </div>
                        <div class="input-group">
                            <label style="text-align: left;">2FA Code</label>
                            <input type="text" id="admin-2fa" placeholder="Enter 6-digit code">
                        </div>
                        <button class="btn-primary" onclick="performAdminLogin()" style="width: 100%; margin-top: 1rem;">Admin Sign In</button>
                        <button class="btn-secondary" onclick="showUserLogin()" style="width: 100%; margin-top: 0.5rem;">Back to User Login</button>
                    </div>
                    
                    <div id="login-message" style="margin-top: 1rem;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for detailed results -->
    <div id="resultModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Results</h3>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        // Navigation
        function showSection(sectionId, evt) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Show selected section
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.add('active');
            }
            
            // Update nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
                // Check if this link calls the same section
                if (link.getAttribute('onclick')?.includes(sectionId)) {
                    link.classList.add('active');
                }
            });
        }

        // Tab switching
        function switchTab(feature, tab, evt) {
            // Update tabs
            const container = document.getElementById(feature);
            if (container) {
                container.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                
                // Find and activate the correct tab
                container.querySelectorAll('.tab').forEach(t => {
                    if (t.getAttribute('onclick')?.includes(tab)) {
                        t.classList.add('active');
                    }
                });
                
                // Update content
                container.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                const tabContent = document.getElementById(`${feature}-${tab}`);
                if (tabContent) {
                    tabContent.classList.add('active');
                }
            }
        }

        // Modal
        function showModal(title, content) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = content;
            document.getElementById('resultModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('resultModal').classList.remove('active');
        }

        // Virtual Screening
        async function runVirtualScreening() {
            const smilesInput = document.getElementById('vhts-smiles');
            if (!smilesInput) {
                alert('Error: Cannot find SMILES input field');
                return;
            }
            const smiles = smilesInput.value.trim();
            if (!smiles) {
                alert('Please enter a SMILES string');
                return;
            }
            const name = document.getElementById('vhts-name')?.value || 'Compound';
            const loading = document.getElementById('screening-loading');
            const results = document.getElementById('screening-results');
            
            loading.classList.add('active');
            results.style.display = 'none';
            
            try {
                const response = await fetch('/api/vhts/screen_compound', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ smiles: smiles, name: name })
                });
                
                const data = await response.json();
                
                let html = `
                    <h3>Screening Results for ${data.compound_id || name}</h3>
                    <div class="result-item">
                        <strong>Total Receptor Hits:</strong> ${data.receptor_hits?.length || 0}<br>
                        <strong>Selectivity:</strong> ${data.selectivity_profile?.status || 'N/A'}<br>
                        <strong>Polypharmacology Score:</strong> ${data.polypharmacology_score || 0}
                    </div>
                `;
                
                if (data.receptor_hits && data.receptor_hits.length > 0) {
                    html += '<h4>Top Receptor Hits:</h4>';
                    data.receptor_hits.slice(0, 10).forEach(hit => {
                        html += `
                            <div class="result-item">
                                <strong>${hit.receptor}</strong> (${hit.family})<br>
                                Binding Score: ${hit.binding_score}<br>
                                Predicted Ki: ${hit.predicted_ki}<br>
                                Activity: ${hit.activity_type}
                            </div>
                        `;
                    });
                }
                
                if (data.safety_flags && data.safety_flags.length > 0) {
                    html += `<div class="message error">‚ö†Ô∏è Safety Flags: ${data.safety_flags.join(', ')}</div>`;
                }
                
                results.innerHTML = html;
                results.style.display = 'block';
            } catch (error) {
                results.innerHTML = `<div class="message error">Error: ${error.message}</div>`;
                results.style.display = 'block';
            } finally {
                loading.classList.remove('active');
            }
        }

        async function runBatchScreening() {
            const compounds = JSON.parse(document.getElementById('batch-compounds').value);
            const loading = document.getElementById('screening-loading');
            const results = document.getElementById('screening-results');
            
            loading.classList.add('active');
            results.style.display = 'none';
            
            try {
                const response = await fetch('/api/vhts/batch_screen', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ compounds: compounds })
                });
                
                const data = await response.json();
                
                let html = '<h3>Batch Screening Report</h3>';
                html += `
                    <div class="result-item">
                        <strong>Total Compounds:</strong> ${data.report?.total_compounds || 0}<br>
                        <strong>Compounds with Hits:</strong> ${data.report?.summary?.compounds_with_hits || 0}<br>
                        <strong>Selective Compounds:</strong> ${data.report?.summary?.selective_compounds || 0}<br>
                        <strong>Safety Concerns:</strong> ${data.report?.summary?.safety_concerns || 0}
                    </div>
                `;
                
                if (data.report?.top_hits) {
                    html += '<h4>Top Hits:</h4>';
                    data.report.top_hits.slice(0, 5).forEach(hit => {
                        html += `
                            <div class="result-item">
                                ${hit.compound} ‚Üí ${hit.receptor} (Score: ${hit.score})
                            </div>
                        `;
                    });
                }
                
                results.innerHTML = html;
                results.style.display = 'block';
            } catch (error) {
                results.innerHTML = `<div class="message error">Error: ${error.message}</div>`;
                results.style.display = 'block';
            } finally {
                loading.classList.remove('active');
            }
        }

        // Lead Optimization
        async function optimizeLead() {
            const smilesInput = document.getElementById('opt-smiles');
            if (!smilesInput) {
                alert('Error: Cannot find lead compound input field');
                return;
            }
            const smiles = smilesInput.value.trim();
            if (!smiles) {
                alert('Please enter a SMILES string');
                return;
            }
            const loading = document.getElementById('opt-loading');
            const results = document.getElementById('opt-results');
            
            loading.classList.add('active');
            results.style.display = 'none';
            
            try {
                const response = await fetch('/api/lead_opt/optimize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ smiles: smiles })
                });
                
                const data = await response.json();
                
                let html = '<h3>Lead Optimization Results</h3>';
                
                if (data.current_properties) {
                    html += `
                        <div class="result-item">
                            <strong>Current Properties:</strong><br>
                            MW: ${data.current_properties.mw}<br>
                            LogP: ${data.current_properties.logp}<br>
                            QED: ${data.current_properties.qed}<br>
                            Synthetic Accessibility: ${data.current_properties.synthetic_accessibility}
                        </div>
                    `;
                }
                
                if (data.modified_structures && data.modified_structures.length > 0) {
                    html += '<h4>Top Optimization Suggestions:</h4>';
                    data.modified_structures.slice(0, 5).forEach((mod, i) => {
                        html += `
                            <div class="result-item">
                                <strong>Option ${i+1}:</strong> ${mod.modification}<br>
                                Strategy: ${mod.strategy}<br>
                                Improvement Score: ${mod.improvement_score}<br>
                                New Properties: MW=${mod.properties.mw}, LogP=${mod.properties.logp}
                            </div>
                        `;
                    });
                }
                
                results.innerHTML = html;
                results.style.display = 'block';
            } catch (error) {
                results.innerHTML = `<div class="message error">Error: ${error.message}</div>`;
                results.style.display = 'block';
            } finally {
                loading.classList.remove('active');
            }
        }

        // Safety Prediction
        async function predictSafety() {
            const smilesInput = document.getElementById('safety-smiles');
            if (!smilesInput) {
                alert('Error: Cannot find safety SMILES input field');
                return;
            }
            const smiles = smilesInput.value.trim();
            if (!smiles) {
                alert('Please enter a SMILES string');
                return;
            }
            const target = document.getElementById('safety-target')?.value || 'Unknown';
            const loading = document.getElementById('safety-loading');
            const results = document.getElementById('safety-results');
            
            loading.classList.add('active');
            results.style.display = 'none';
            
            try {
                const response = await fetch('/api/off_target/predict', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ smiles: smiles, primary_target: target })
                });
                
                const data = await response.json();
                const pred = data.prediction;
                
                let html = '<h3>Safety Assessment Report</h3>';
                
                // Risk summary
                const riskColor = pred.risk_score > 50 ? 'red' : pred.risk_score > 30 ? 'orange' : 'green';
                html += `
                    <div class="result-item">
                        <strong>Overall Risk Score:</strong> <span style="color: ${riskColor}; font-size: 24px;">${pred.risk_score}/100</span><br>
                        <strong>Classification:</strong> ${pred.safety_classification}<br>
                        <strong>DDI Risk:</strong> ${pred.drug_drug_interaction_risk}
                    </div>
                `;
                
                // Safety alerts
                if (pred.safety_alerts && pred.safety_alerts.length > 0) {
                    html += '<h4>Safety Alerts:</h4>';
                    pred.safety_alerts.forEach(alert => {
                        const alertColor = alert.level === 'CRITICAL' ? 'red' : alert.level === 'HIGH' ? 'orange' : 'yellow';
                        html += `
                            <div class="message" style="background: ${alertColor}20; border-color: ${alertColor};">
                                <strong>${alert.level}:</strong> ${alert.message}<br>
                                <em>Recommendation:</em> ${alert.recommendation}
                            </div>
                        `;
                    });
                }
                
                // Off-targets
                if (pred.off_target_hits && pred.off_target_hits.length > 0) {
                    html += '<h4>Off-Target Interactions:</h4>';
                    pred.off_target_hits.forEach(hit => {
                        html += `
                            <div class="result-item">
                                <strong>${hit.target}</strong> (${hit.category})<br>
                                Predicted IC50: ${hit.predicted_ic50}<br>
                                Concern: ${hit.concern}<br>
                                Severity: <span style="color: ${hit.severity === 'critical' ? 'red' : hit.severity === 'high' ? 'orange' : 'black'};">${hit.severity}</span>
                            </div>
                        `;
                    });
                }
                
                // Predicted side effects
                if (pred.predicted_side_effects && pred.predicted_side_effects.length > 0) {
                    html += '<h4>Predicted Side Effects:</h4>';
                    html += '<div class="result-item">';
                    html += pred.predicted_side_effects.map(effect => `‚Ä¢ ${effect}`).join('<br>');
                    html += '</div>';
                }
                
                results.innerHTML = html;
                results.style.display = 'block';
            } catch (error) {
                results.innerHTML = `<div class="message error">Error: ${error.message}</div>`;
                results.style.display = 'block';
            } finally {
                loading.classList.remove('active');
            }
        }

        // Compound Analysis
        async function analyzeCompound() {
            const input = document.getElementById('analysis-input').value;
            const loading = document.getElementById('analysis-loading');
            const results = document.getElementById('analysis-results');
            
            loading.classList.add('active');
            results.style.display = 'none';
            
            try {
                const response = await fetch('/api/analyze_compound', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ compound: input })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                let html = `<h3>Analysis: ${data.name}</h3>`;
                
                // Structure visualization
                if (data.structure_svg) {
                    html += `<div style="text-align: center; margin: 20px 0;">${data.structure_svg}</div>`;
                }
                
                // Properties
                html += `
                    <div class="result-item">
                        <strong>SMILES:</strong> ${data.smiles}<br>
                        <strong>Formula:</strong> ${data.formula}<br>
                        <strong>MW:</strong> ${data.molecular_weight}<br>
                        <strong>LogP:</strong> ${data.logP}
                    </div>
                `;
                
                // Targets
                if (data.targets && data.targets.length > 0) {
                    html += '<h4>Known Targets:</h4>';
                    html += '<div class="result-item">' + data.targets.join(', ') + '</div>';
                }
                
                // Therapeutic uses
                if (data.therapeutic_uses && data.therapeutic_uses.length > 0) {
                    html += '<h4>Therapeutic Uses:</h4>';
                    html += '<div class="result-item">' + data.therapeutic_uses.join(', ') + '</div>';
                }
                
                results.innerHTML = html;
                results.style.display = 'block';
            } catch (error) {
                results.innerHTML = `<div class="message error">Error: ${error.message}</div>`;
                results.style.display = 'block';
            } finally {
                loading.classList.remove('active');
            }
        }

        // SAR Analysis
        async function analyzeSAR() {
            const compounds = JSON.parse(document.getElementById('sar-compounds').value);
            const loading = document.getElementById('sar-loading');
            const results = document.getElementById('sar-results');
            
            loading.classList.add('active');
            results.style.display = 'none';
            
            try {
                const response = await fetch('/api/sar/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ compounds: compounds })
                });
                
                const data = await response.json();
                
                let html = '<h3>SAR Analysis Results</h3>';
                html += `
                    <div class="result-item">
                        <strong>Series Size:</strong> ${data.series_size} compounds<br>
                        <strong>Activity Cliffs:</strong> ${data.activity_cliffs?.length || 0} identified
                    </div>
                `;
                
                // Key features
                if (data.key_features && data.key_features.length > 0) {
                    html += '<h4>Key Features Affecting Activity:</h4>';
                    data.key_features.slice(0, 5).forEach(feat => {
                        const color = feat.importance === 'positive' ? 'green' : feat.importance === 'negative' ? 'red' : 'gray';
                        html += `
                            <div class="result-item">
                                <strong style="color: ${color};">${feat.fragment}</strong><br>
                                Contribution: ${feat.contribution}<br>
                                Occurrence: ${feat.occurrence} compounds<br>
                                Importance: ${feat.importance}
                            </div>
                        `;
                    });
                }
                
                // Activity cliffs
                if (data.activity_cliffs && data.activity_cliffs.length > 0) {
                    html += '<h4>Activity Cliffs:</h4>';
                    data.activity_cliffs.slice(0, 3).forEach(cliff => {
                        html += `
                            <div class="result-item">
                                ${cliff.compound1} vs ${cliff.compound2}<br>
                                Similarity: ${cliff.similarity}<br>
                                Activity Œî: ${cliff.activity_difference}<br>
                                Cliff Steepness: ${cliff.cliff_steepness}
                            </div>
                        `;
                    });
                }
                
                results.innerHTML = html;
                results.style.display = 'block';
            } catch (error) {
                results.innerHTML = `<div class="message error">Error: ${error.message}</div>`;
                results.style.display = 'block';
            } finally {
                loading.classList.remove('active');
            }
        }

        // Quantum Simulations
        async function simulateProteinFolding() {
            const sequence = document.getElementById('protein-seq').value;
            const loading = document.getElementById('quantum-loading');
            const results = document.getElementById('quantum-results');
            
            loading.classList.add('active');
            results.style.display = 'none';
            
            try {
                const response = await fetch('/api/quantum/protein_folding', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sequence: sequence })
                });
                
                const data = await response.json();
                
                let html = '<h3>Quantum Protein Folding Results</h3>';
                html += `
                    <div class="result-item">
                        <strong>Sequence Length:</strong> ${data.length} amino acids<br>
                        <strong>Algorithm:</strong> ${data.algorithm}<br>
                        <strong>Predicted Structure:</strong> ${data.folding_prediction?.predicted_structure}<br>
                        <strong>Confidence:</strong> ${data.folding_prediction?.confidence?.toFixed(1)}%
                    </div>
                    <div class="result-item">
                        <strong>Computational Advantage:</strong><br>
                        Classical Steps: ${data.computational_advantage?.classical_steps}<br>
                        Quantum Steps: ${data.computational_advantage?.quantum_steps}<br>
                        <strong style="color: green;">Speedup: ${data.computational_advantage?.speedup}</strong>
                    </div>
                    <div class="result-item">
                        <strong>Quantum Resources:</strong><br>
                        Qubits Required: ${data.quantum_requirements?.qubits}<br>
                        Gates: ${data.quantum_requirements?.gates}<br>
                        Coherence Time: ${data.quantum_requirements?.coherence_time}
                    </div>
                `;
                
                results.innerHTML = html;
                results.style.display = 'block';
            } catch (error) {
                results.innerHTML = `<div class="message error">Error: ${error.message}</div>`;
                results.style.display = 'block';
            } finally {
                loading.classList.remove('active');
            }
        }

        async function runQuantumMD() {
            const smiles = document.getElementById('qmd-smiles').value;
            const target = document.getElementById('qmd-target').value;
            const loading = document.getElementById('quantum-loading');
            const results = document.getElementById('quantum-results');
            
            loading.classList.add('active');
            results.style.display = 'none';
            
            try {
                const response = await fetch('/api/quantum/molecular_dynamics', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ smiles: smiles, target: target })
                });
                
                const data = await response.json();
                
                let html = '<h3>Quantum Molecular Dynamics Results</h3>';
                html += `
                    <div class="result-item">
                        <strong>Target:</strong> ${data.target}<br>
                        <strong>Binding Energy:</strong> ${data.results?.binding_energy} kcal/mol<br>
                        <strong>Simulation Time:</strong> ${data.quantum_parameters?.simulation_time}
                    </div>
                    <div class="result-item">
                        <strong>Performance:</strong><br>
                        Quantum Time: ${data.performance_comparison?.quantum_time}<br>
                        Classical Time: ${data.performance_comparison?.classical_time}<br>
                        <strong style="color: green;">Speedup: ${data.performance_comparison?.speedup}</strong><br>
                        Accuracy Improvement: ${data.performance_comparison?.accuracy_improvement}
                    </div>
                `;
                
                results.innerHTML = html;
                results.style.display = 'block';
            } catch (error) {
                results.innerHTML = `<div class="message error">Error: ${error.message}</div>`;
                results.style.display = 'block';
            } finally {
                loading.classList.remove('active');
            }
        }

        async function quantumOptimize() {
            const smiles = document.getElementById('qopt-smiles').value;
            const loading = document.getElementById('quantum-loading');
            const results = document.getElementById('quantum-results');
            
            loading.classList.add('active');
            results.style.display = 'none';
            
            try {
                const response = await fetch('/api/quantum/lead_optimization', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ smiles: smiles })
                });
                
                const data = await response.json();
                
                let html = '<h3>Quantum Lead Optimization Results</h3>';
                html += `
                    <div class="result-item">
                        <strong>Algorithm:</strong> ${data.quantum_setup?.algorithm}<br>
                        <strong>Qubits:</strong> ${data.quantum_setup?.qubits}<br>
                        <strong>Search Space:</strong> ${data.computational_advantage?.search_space}<br>
                        <strong>Expected Improvement:</strong> ${data.computational_advantage?.expected_improvement}
                    </div>
                `;
                
                if (data.optimized_structures && data.optimized_structures.length > 0) {
                    html += '<h4>Quantum-Optimized Variants:</h4>';
                    data.optimized_structures.forEach(opt => {
                        html += `
                            <div class="result-item">
                                <strong>${opt.variant}:</strong> Score ${opt.quantum_score}<br>
                                Improvements: Binding ${opt.improvements?.binding_affinity}, 
                                Selectivity ${opt.improvements?.selectivity}, 
                                Stability ${opt.improvements?.stability}
                            </div>
                        `;
                    });
                }
                
                results.innerHTML = html;
                results.style.display = 'block';
            } catch (error) {
                results.innerHTML = `<div class="message error">Error: ${error.message}</div>`;
                results.style.display = 'block';
            } finally {
                loading.classList.remove('active');
            }
        }

        // ============== PKPD/PBPK Functions ==============
        async function runPKPDSimulation() {
            const loading = document.getElementById('pkpd-loading');
            const results = document.getElementById('pkpd-results');
            
            loading.classList.add('active');
            results.style.display = 'none';
            
            const params = {
                drug: document.getElementById('pkpd-drug').value,
                dose: parseFloat(document.getElementById('pkpd-dose').value),
                clearance: parseFloat(document.getElementById('pkpd-clearance').value),
                vd: parseFloat(document.getElementById('pkpd-vd').value),
                ka: parseFloat(document.getElementById('pkpd-ka').value),
                patient: {
                    age: parseInt(document.getElementById('pkpd-age').value),
                    weight: parseFloat(document.getElementById('pkpd-weight').value),
                    liver_function: parseFloat(document.getElementById('pkpd-liver').value),
                    creatinine_clearance: parseFloat(document.getElementById('pkpd-creatinine').value)
                },
                model_type: document.getElementById('pkpd-model').value
            };
            
            try {
                const response = await fetch('/api/pkpd/simulate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(params)
                });
                
                const data = await response.json();
                
                let html = '<h3>Pharmacokinetic Simulation Results</h3>';
                
                // PK Parameters
                html += `
                    <div class="result-item" style="background: linear-gradient(135deg, #667eea20 0%, #764ba220 100%); padding: 1.5rem; border-radius: 10px;">
                        <h4 style="color: #667eea; margin-bottom: 1rem;">PK Parameters</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                            <div><strong>Cmax:</strong> ${data.cmax?.toFixed(2) || 'N/A'} mg/L</div>
                            <div><strong>Tmax:</strong> ${data.tmax?.toFixed(2) || 'N/A'} h</div>
                            <div><strong>AUC:</strong> ${data.auc?.toFixed(2) || 'N/A'} mg*h/L</div>
                            <div><strong>Half-life:</strong> ${data.half_life?.toFixed(2) || 'N/A'} h</div>
                            <div><strong>Clearance:</strong> ${data.clearance?.toFixed(2) || 'N/A'} L/h</div>
                            <div><strong>Vd:</strong> ${data.volume_distribution?.toFixed(2) || 'N/A'} L</div>
                        </div>
                    </div>
                `;
                
                // Concentration-Time Curve (simple text visualization)
                if (data.concentration && data.time) {
                    html += '<h4 style="margin-top: 1.5rem;">Concentration-Time Profile</h4>';
                    html += '<div class="result-item" style="font-family: monospace; background: #f5f5f5; padding: 1rem; border-radius: 10px;">';
                    
                    // Create simple ASCII-style chart
                    const maxConc = Math.max(...data.concentration);
                    const chartHeight = 10;
                    const chartWidth = 50;
                    const step = Math.floor(data.concentration.length / chartWidth);
                    
                    for (let row = chartHeight; row >= 0; row--) {
                        let line = '';
                        const threshold = (row / chartHeight) * maxConc;
                        for (let col = 0; col < chartWidth; col++) {
                            const idx = col * step;
                            if (idx < data.concentration.length && data.concentration[idx] >= threshold) {
                                line += '‚ñà';
                            } else {
                                line += row === 0 ? '‚îÄ' : ' ';
                            }
                        }
                        html += line + (row === chartHeight ? ` ${maxConc.toFixed(1)} mg/L` : '') + '<br>';
                    }
                    html += '‚îî' + '‚îÄ'.repeat(chartWidth) + '‚Üí Time (0-24h)';
                    html += '</div>';
                }
                
                // Clinical interpretation
                html += `
                    <div class="result-item" style="margin-top: 1rem;">
                        <h4 style="color: #667eea;">Clinical Interpretation</h4>
                        <p>Based on the simulated PK profile, the drug reaches peak concentration at ${data.tmax?.toFixed(1) || 'N/A'} hours. 
                        With a half-life of ${data.half_life?.toFixed(1) || 'N/A'} hours, approximately 97% of the drug will be eliminated after 
                        ${(data.half_life * 5)?.toFixed(1) || 'N/A'} hours (5 half-lives).</p>
                    </div>
                `;
                
                results.innerHTML = html;
                results.style.display = 'block';
            } catch (error) {
                results.innerHTML = `<div class="message error">Error: ${error.message}</div>`;
                results.style.display = 'block';
            } finally {
                loading.classList.remove('active');
            }
        }

        async function runPopulationPK() {
            const loading = document.getElementById('pkpd-loading');
            const results = document.getElementById('pkpd-results');
            
            loading.classList.add('active');
            results.style.display = 'none';
            
            const params = {
                drug: document.getElementById('pop-drug').value,
                dose: parseFloat(document.getElementById('pop-dose').value),
                population_size: parseInt(document.getElementById('pop-size').value),
                age_range: [
                    parseInt(document.getElementById('pop-age-min').value),
                    parseInt(document.getElementById('pop-age-max').value)
                ],
                include_hepatic: document.getElementById('pop-hepatic').checked,
                include_renal: document.getElementById('pop-renal').checked,
                include_elderly: document.getElementById('pop-elderly').checked
            };
            
            try {
                const response = await fetch('/api/pkpd/population', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(params)
                });
                
                const data = await response.json();
                const stats = data.population_statistics || {};
                
                let html = '<h3>Population PK Analysis</h3>';
                
                html += `
                    <div class="result-item" style="background: linear-gradient(135deg, #667eea20 0%, #764ba220 100%); padding: 1.5rem; border-radius: 10px;">
                        <h4 style="color: #667eea; margin-bottom: 1rem;">Population Statistics (n=${stats.n_patients || 0})</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <div>
                                <strong>Cmax:</strong><br>
                                Mean: ${stats.cmax_mean?.toFixed(2) || 'N/A'} mg/L<br>
                                SD: ${stats.cmax_std?.toFixed(2) || 'N/A'}<br>
                                Range: ${stats.cmax_range?.[0]?.toFixed(2) || 'N/A'} - ${stats.cmax_range?.[1]?.toFixed(2) || 'N/A'}
                            </div>
                            <div>
                                <strong>AUC:</strong><br>
                                Mean: ${stats.auc_mean?.toFixed(2) || 'N/A'} mg*h/L<br>
                                SD: ${stats.auc_std?.toFixed(2) || 'N/A'}<br>
                                Range: ${stats.auc_range?.[0]?.toFixed(2) || 'N/A'} - ${stats.auc_range?.[1]?.toFixed(2) || 'N/A'}
                            </div>
                            <div>
                                <strong>Variability:</strong><br>
                                CV%: ${stats.variability_coefficient?.toFixed(1) || 'N/A'}%
                            </div>
                        </div>
                    </div>
                `;
                
                // High-risk patients
                if (data.high_risk_patients && data.high_risk_patients.length > 0) {
                    html += '<h4 style="margin-top: 1.5rem; color: #dc3545;">High-Risk Patients Identified</h4>';
                    data.high_risk_patients.slice(0, 5).forEach(patient => {
                        html += `
                            <div class="message" style="background: #f8d7da; border-color: #dc3545; margin-bottom: 0.5rem;">
                                <strong>Patient ${patient.patient_id}:</strong> 
                                Age ${patient.patient_age}, ${patient.patient_weight}kg<br>
                                Risk: ${patient.risk_reason} | Recommendation: ${patient.dose_adjustment || 'Monitor closely'}
                            </div>
                        `;
                    });
                }
                
                results.innerHTML = html;
                results.style.display = 'block';
            } catch (error) {
                results.innerHTML = `<div class="message error">Error: ${error.message}</div>`;
                results.style.display = 'block';
            } finally {
                loading.classList.remove('active');
            }
        }

        async function runPBPKSimulation() {
            const loading = document.getElementById('pkpd-loading');
            const results = document.getElementById('pkpd-results');
            
            loading.classList.add('active');
            results.style.display = 'none';
            
            const params = {
                drug: document.getElementById('pbpk-drug').value,
                dose: parseFloat(document.getElementById('pbpk-dose').value),
                logp: parseFloat(document.getElementById('pbpk-logp').value),
                fraction_unbound: parseFloat(document.getElementById('pbpk-fu').value),
                organs: {
                    liver: document.getElementById('pbpk-liver').checked,
                    kidney: document.getElementById('pbpk-kidney').checked,
                    brain: document.getElementById('pbpk-brain').checked,
                    heart: document.getElementById('pbpk-heart').checked,
                    muscle: document.getElementById('pbpk-muscle').checked
                }
            };
            
            try {
                const response = await fetch('/api/pkpd/pbpk', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(params)
                });
                
                const data = await response.json();
                
                let html = '<h3>PBPK Model Results</h3>';
                
                // Organ concentrations
                if (data.organ_concentrations) {
                    html += '<h4 style="color: #667eea;">Organ Distribution (Cmax)</h4>';
                    html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">';
                    for (const [organ, conc] of Object.entries(data.organ_concentrations)) {
                        const barWidth = Math.min(100, (conc / Math.max(...Object.values(data.organ_concentrations))) * 100);
                        html += `
                            <div class="result-item" style="padding: 1rem;">
                                <strong>${organ.charAt(0).toUpperCase() + organ.slice(1)}</strong><br>
                                <div style="background: #e9ecef; border-radius: 5px; height: 20px; margin-top: 5px;">
                                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); width: ${barWidth}%; height: 100%; border-radius: 5px;"></div>
                                </div>
                                <small>${conc?.toFixed(2) || 'N/A'} mg/L</small>
                            </div>
                        `;
                    }
                    html += '</div>';
                }
                
                // PK parameters
                html += `
                    <div class="result-item" style="margin-top: 1.5rem;">
                        <h4 style="color: #667eea;">Systemic PK Parameters</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                            <div><strong>Plasma Cmax:</strong> ${data.plasma_cmax?.toFixed(2) || 'N/A'} mg/L</div>
                            <div><strong>AUC:</strong> ${data.auc?.toFixed(2) || 'N/A'} mg*h/L</div>
                            <div><strong>Hepatic Clearance:</strong> ${data.hepatic_clearance?.toFixed(2) || 'N/A'} L/h</div>
                            <div><strong>Renal Clearance:</strong> ${data.renal_clearance?.toFixed(2) || 'N/A'} L/h</div>
                        </div>
                    </div>
                `;
                
                results.innerHTML = html;
                results.style.display = 'block';
            } catch (error) {
                results.innerHTML = `<div class="message error">Error: ${error.message}</div>`;
                results.style.display = 'block';
            } finally {
                loading.classList.remove('active');
            }
        }

        // ============== DDI Scanner Functions ==============
        async function scanDDIPair() {
            const loading = document.getElementById('ddi-loading');
            const results = document.getElementById('ddi-results');
            
            loading.classList.add('active');
            results.style.display = 'none';
            
            const drug1 = document.getElementById('ddi-drug1').value;
            const drug2 = document.getElementById('ddi-drug2').value;
            
            try {
                const response = await fetch('/api/ddi_analysis', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ drug1: drug1, drug2: drug2 })
                });
                
                const data = await response.json();
                
                let html = '<h3>Drug-Drug Interaction Analysis</h3>';
                
                // Risk level with color coding
                const riskColors = {
                    'Very High': '#dc3545',
                    'High': '#fd7e14',
                    'Moderate': '#ffc107',
                    'Low': '#28a745',
                    'Minimal': '#20c997'
                };
                const riskColor = riskColors[data.risk_level] || '#6c757d';
                
                html += `
                    <div class="result-item" style="background: ${riskColor}20; border-left: 5px solid ${riskColor}; padding: 1.5rem;">
                        <h4 style="color: ${riskColor}; font-size: 24px;">${data.risk_level || 'Unknown'} Risk</h4>
                        <p><strong>${drug1}</strong> + <strong>${drug2}</strong></p>
                    </div>
                `;
                
                // Mechanism
                if (data.mechanism) {
                    html += `
                        <div class="result-item">
                            <h4 style="color: #667eea;">Mechanism of Interaction</h4>
                            <p>${data.mechanism}</p>
                        </div>
                    `;
                }
                
                // Synergy/Antagonism
                if (data.synergy) {
                    html += `
                        <div class="result-item">
                            <h4 style="color: #667eea;">Synergy/Antagonism</h4>
                            <p>${data.synergy}</p>
                        </div>
                    `;
                }
                
                // Clinical Recommendations
                if (data.recommendation) {
                    html += `
                        <div class="result-item" style="background: #e3f2fd; border-left: 5px solid #2196f3;">
                            <h4 style="color: #1976d2;">Clinical Recommendation</h4>
                            <p>${data.recommendation}</p>
                        </div>
                    `;
                }
                
                // Dosage Adjustment
                if (data.dosage_adjustment) {
                    html += `
                        <div class="result-item" style="background: #fff3e0; border-left: 5px solid #ff9800;">
                            <h4 style="color: #f57c00;">Dosage Adjustment</h4>
                            <p>${data.dosage_adjustment}</p>
                        </div>
                    `;
                }
                
                results.innerHTML = html;
                results.style.display = 'block';
            } catch (error) {
                results.innerHTML = `<div class="message error">Error: ${error.message}</div>`;
                results.style.display = 'block';
            } finally {
                loading.classList.remove('active');
            }
        }

        async function analyzeCYPProfile() {
            const loading = document.getElementById('ddi-loading');
            const results = document.getElementById('ddi-results');
            
            loading.classList.add('active');
            results.style.display = 'none';
            
            const compound = document.getElementById('cyp-compound').value;
            const enzymes = [];
            if (document.getElementById('cyp-3a4').checked) enzymes.push('CYP3A4');
            if (document.getElementById('cyp-2d6').checked) enzymes.push('CYP2D6');
            if (document.getElementById('cyp-2c9').checked) enzymes.push('CYP2C9');
            if (document.getElementById('cyp-2c19').checked) enzymes.push('CYP2C19');
            if (document.getElementById('cyp-1a2').checked) enzymes.push('CYP1A2');
            
            try {
                const response = await fetch('/api/analyze_compound', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ compound: compound, analyze_cyp: true, enzymes: enzymes })
                });
                
                const data = await response.json();
                
                let html = `<h3>CYP450 Profile: ${data.name || compound}</h3>`;
                
                // CYP Substrates
                if (data.cyp_substrates || data.metabolism?.cyp_substrates) {
                    const cyp = data.cyp_substrates || data.metabolism?.cyp_substrates || {};
                    html += '<h4 style="color: #667eea; margin-top: 1rem;">CYP450 Substrate Prediction</h4>';
                    html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">';
                    
                    for (const enzyme of enzymes) {
                        const isSubstrate = cyp[enzyme];
                        const status = isSubstrate ? 'Likely Substrate' : 'Unlikely Substrate';
                        const color = isSubstrate ? '#dc3545' : '#28a745';
                        const icon = isSubstrate ? '‚ö†Ô∏è' : '‚úì';
                        
                        html += `
                            <div class="result-item" style="text-align: center; border: 2px solid ${color}20;">
                                <h5 style="color: ${color};">${enzyme}</h5>
                                <div style="font-size: 24px;">${icon}</div>
                                <p style="color: ${color}; font-weight: bold;">${status}</p>
                            </div>
                        `;
                    }
                    html += '</div>';
                }
                
                // Drug interaction warnings
                html += `
                    <div class="result-item" style="margin-top: 1.5rem; background: #fff3cd; border-left: 5px solid #ffc107;">
                        <h4 style="color: #856404;">Potential Interaction Drugs</h4>
                        <p>Based on CYP profile, be cautious when combining with:</p>
                        <ul>
                            <li><strong>CYP3A4 inhibitors:</strong> Ketoconazole, Itraconazole, Ritonavir, Grapefruit juice</li>
                            <li><strong>CYP2D6 inhibitors:</strong> Fluoxetine, Paroxetine, Quinidine</li>
                            <li><strong>CYP3A4 inducers:</strong> Rifampin, Carbamazepine, St. John's Wort</li>
                        </ul>
                    </div>
                `;
                
                results.innerHTML = html;
                results.style.display = 'block';
            } catch (error) {
                results.innerHTML = `<div class="message error">Error: ${error.message}</div>`;
                results.style.display = 'block';
            } finally {
                loading.classList.remove('active');
            }
        }

        async function analyzeDrugCocktail() {
            const loading = document.getElementById('ddi-loading');
            const results = document.getElementById('ddi-results');
            
            loading.classList.add('active');
            results.style.display = 'none';
            
            const drugsText = document.getElementById('cocktail-drugs').value;
            const drugs = drugsText.split('\n').map(d => d.trim()).filter(d => d.length > 0);
            
            const patientProfile = {
                liver_disease: document.getElementById('cocktail-liver').checked,
                kidney_disease: document.getElementById('cocktail-kidney').checked,
                elderly: document.getElementById('cocktail-elderly').checked,
                pregnant: document.getElementById('cocktail-pregnant').checked
            };
            
            try {
                const response = await fetch('/api/psychiatric-analysis', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ drugs: drugs, patient_profile: patientProfile })
                });
                
                const data = await response.json();
                
                let html = `<h3>Drug Cocktail Safety Analysis</h3>`;
                html += `<p style="color: #666;">Analyzing ${drugs.length} drugs: ${drugs.join(', ')}</p>`;
                
                // Overall safety score
                const safetyScore = data.safety_score || 75;
                const safetyColor = safetyScore > 70 ? '#28a745' : safetyScore > 40 ? '#ffc107' : '#dc3545';
                
                html += `
                    <div class="result-item" style="text-align: center; padding: 2rem;">
                        <h4>Overall Safety Score</h4>
                        <div style="font-size: 48px; color: ${safetyColor}; font-weight: bold;">${safetyScore}/100</div>
                    </div>
                `;
                
                // Pairwise interactions
                if (data.interactions && data.interactions.length > 0) {
                    html += '<h4 style="margin-top: 1.5rem; color: #dc3545;">Identified Interactions</h4>';
                    data.interactions.forEach(interaction => {
                        const riskColor = interaction.risk_level === 'High' ? '#dc3545' : 
                                         interaction.risk_level === 'Moderate' ? '#ffc107' : '#28a745';
                        html += `
                            <div class="result-item" style="border-left: 4px solid ${riskColor};">
                                <strong>${interaction.drug1} + ${interaction.drug2}</strong>
                                <span style="color: ${riskColor}; float: right;">${interaction.risk_level} Risk</span><br>
                                <small>${interaction.mechanism || 'Potential interaction identified'}</small>
                            </div>
                        `;
                    });
                }
                
                // Recommendations
                if (data.recommendations && data.recommendations.length > 0) {
                    html += '<h4 style="margin-top: 1.5rem; color: #667eea;">Recommendations</h4>';
                    data.recommendations.forEach(rec => {
                        html += `<div class="result-item">‚Ä¢ ${rec}</div>`;
                    });
                }
                
                results.innerHTML = html;
                results.style.display = 'block';
            } catch (error) {
                results.innerHTML = `<div class="message error">Error: ${error.message}</div>`;
                results.style.display = 'block';
            } finally {
                loading.classList.remove('active');
            }
        }

        // ============== Patent-Free Analog Functions ==============
        async function generatePatentFreeAnalogs() {
            const loading = document.getElementById('analogs-loading');
            const results = document.getElementById('analogs-results');
            
            loading.classList.add('active');
            results.style.display = 'none';
            
            const params = {
                parent_compound: document.getElementById('analog-parent').value,
                min_similarity: parseFloat(document.getElementById('analog-similarity').value),
                num_analogs: parseInt(document.getElementById('analog-count').value),
                patent_filter: document.getElementById('analog-patent-filter').value,
                optimize: {
                    efficacy: document.getElementById('analog-efficacy').checked,
                    safety: document.getElementById('analog-safety').checked,
                    drug_likeness: document.getElementById('analog-druglike').checked,
                    novelty: document.getElementById('analog-novelty').checked
                }
            };
            
            try {
                const response = await fetch('/api/generate_analog', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(params)
                });
                
                const data = await response.json();
                
                let html = `<h3>Patent-Free Analog Results for ${data.parent_compound || params.parent_compound}</h3>`;
                
                // Summary statistics
                if (data.summary) {
                    html += `
                        <div class="result-item" style="background: linear-gradient(135deg, #667eea20 0%, #764ba220 100%); padding: 1.5rem; border-radius: 10px;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; text-align: center;">
                                <div>
                                    <div style="font-size: 28px; color: #667eea; font-weight: bold;">${data.summary.total_analogs || 0}</div>
                                    <small>Total Analogs</small>
                                </div>
                                <div>
                                    <div style="font-size: 28px; color: #28a745; font-weight: bold;">${data.summary.patent_free_analogs || 0}</div>
                                    <small>Patent-Free</small>
                                </div>
                                <div>
                                    <div style="font-size: 28px; color: #764ba2; font-weight: bold;">${data.summary.high_potential_analogs || 0}</div>
                                    <small>High Potential</small>
                                </div>
                                <div>
                                    <div style="font-size: 28px; color: #17a2b8; font-weight: bold;">${(data.summary.average_similarity * 100)?.toFixed(0) || 0}%</div>
                                    <small>Avg Similarity</small>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // Individual analogs
                if (data.analogs && data.analogs.length > 0) {
                    html += '<h4 style="margin-top: 1.5rem;">Generated Analogs</h4>';
                    
                    data.analogs.forEach((analog, i) => {
                        const patentColors = {
                            'Patent-Free': '#28a745',
                            'Patent Expired': '#20c997',
                            'Patent Pending': '#ffc107',
                            'Patented': '#dc3545'
                        };
                        const patentColor = patentColors[analog.patent_status] || '#6c757d';
                        const patentIcon = analog.patent_status === 'Patent-Free' ? 'üîì' : 
                                          analog.patent_status === 'Patent Expired' ? '‚úì' :
                                          analog.patent_status === 'Patent Pending' ? '‚è≥' : 'üîí';
                        
                        html += `
                            <div class="result-item" style="border-left: 4px solid ${patentColor}; margin-bottom: 1rem;">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div>
                                        <h5 style="margin: 0;">${analog.name || `Analog ${i+1}`}</h5>
                                        <small style="color: #666; word-break: break-all;">${analog.smiles}</small>
                                    </div>
                                    <span style="background: ${patentColor}; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px;">
                                        ${patentIcon} ${analog.patent_status}
                                    </span>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 0.5rem; margin-top: 1rem;">
                                    <div><strong>Similarity:</strong> ${(analog.similarity * 100)?.toFixed(0)}%</div>
                                    <div><strong>Safety:</strong> ${analog.safety_score}/100</div>
                                    <div><strong>Efficacy:</strong> ${analog.efficacy_score}/100</div>
                                    <div><strong>Novelty:</strong> ${analog.novelty_score}/100</div>
                                </div>
                                
                                ${analog.therapeutic_potential ? `
                                    <div style="margin-top: 0.5rem;">
                                        <strong>Therapeutic Potential:</strong> 
                                        <span style="color: ${analog.therapeutic_potential === 'Very High' ? '#28a745' : '#667eea'};">
                                            ${analog.therapeutic_potential}
                                        </span>
                                        ${analog.estimated_value ? `| <strong>Est. Value:</strong> ${analog.estimated_value}` : ''}
                                    </div>
                                ` : ''}
                                
                                ${analog.patent_opportunity_score ? `
                                    <div style="margin-top: 0.5rem; padding: 0.5rem; background: #f8f9fa; border-radius: 5px;">
                                        <strong>IP Opportunity Score:</strong> 
                                        <span style="font-size: 18px; color: #667eea; font-weight: bold;">${analog.patent_opportunity_score}/100</span>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    });
                }
                
                results.innerHTML = html;
                results.style.display = 'block';
            } catch (error) {
                results.innerHTML = `<div class="message error">Error: ${error.message}</div>`;
                results.style.display = 'block';
            } finally {
                loading.classList.remove('active');
            }
        }

        async function analyzeIPOpportunity() {
            const loading = document.getElementById('analogs-loading');
            const results = document.getElementById('analogs-results');
            
            loading.classList.add('active');
            results.style.display = 'none';
            
            const smiles = document.getElementById('ip-smiles').value;
            
            try {
                const response = await fetch('/api/retrosynthesis', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ smiles: smiles })
                });
                
                const data = await response.json();
                
                let html = '<h3>IP Opportunity Analysis</h3>';
                
                // Synthesis complexity
                html += `
                    <div class="result-item">
                        <h4 style="color: #667eea;">Synthetic Complexity</h4>
                        <p>Complexity Score: <strong>${data.complexity_score?.toFixed(1) || 'N/A'}/10</strong></p>
                        <p>${data.complexity_score > 7 ? 'High complexity may provide IP protection advantages' : 
                           data.complexity_score > 4 ? 'Moderate complexity' : 'Low complexity - easier to reproduce'}</p>
                    </div>
                `;
                
                // Commercial availability
                if (data.commercial_availability) {
                    html += `
                        <div class="result-item">
                            <h4 style="color: #667eea;">Commercial Availability</h4>
                            <p><strong>Status:</strong> ${data.commercial_availability.compound_availability}</p>
                            <p><strong>Est. Price:</strong> ${data.commercial_availability.estimated_price}</p>
                            <p><strong>Potential Suppliers:</strong> ${data.commercial_availability.potential_suppliers?.join(', ') || 'N/A'}</p>
                        </div>
                    `;
                }
                
                // Recommendations
                if (data.recommendations && data.recommendations.length > 0) {
                    html += '<h4 style="color: #667eea; margin-top: 1rem;">Synthesis Recommendations</h4>';
                    data.recommendations.forEach(rec => {
                        html += `<div class="result-item">‚Ä¢ ${rec}</div>`;
                    });
                }
                
                results.innerHTML = html;
                results.style.display = 'block';
            } catch (error) {
                results.innerHTML = `<div class="message error">Error: ${error.message}</div>`;
                results.style.display = 'block';
            } finally {
                loading.classList.remove('active');
            }
        }

        async function searchDatabases() {
            const loading = document.getElementById('analogs-loading');
            const results = document.getElementById('analogs-results');
            
            loading.classList.add('active');
            results.style.display = 'none';
            
            const searchTerm = document.getElementById('db-search').value;
            const databases = [];
            if (document.getElementById('db-pubchem').checked) databases.push('pubchem');
            if (document.getElementById('db-chembl').checked) databases.push('chembl');
            if (document.getElementById('db-fda').checked) databases.push('fda');
            if (document.getElementById('db-internal').checked) databases.push('internal');
            
            let html = `<h3>Database Search Results: "${searchTerm}"</h3>`;
            
            try {
                // Search each selected database
                for (const db of databases) {
                    let endpoint = '';
                    if (db === 'pubchem') endpoint = `/api/external/pubchem/${encodeURIComponent(searchTerm)}`;
                    else if (db === 'chembl') endpoint = `/api/external/chembl/${encodeURIComponent(searchTerm)}`;
                    else if (db === 'fda') endpoint = `/api/external/fda/${encodeURIComponent(searchTerm)}`;
                    else endpoint = `/api/analyze_compound`;
                    
                    try {
                        let response;
                        if (db === 'internal') {
                            response = await fetch(endpoint, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ compound: searchTerm })
                            });
                        } else {
                            response = await fetch(endpoint);
                        }
                        
                        const data = await response.json();
                        
                        const dbNames = {
                            'pubchem': 'PubChem',
                            'chembl': 'ChEMBL',
                            'fda': 'FDA Orange Book',
                            'internal': 'Internal Database'
                        };
                        
                        const statusColor = data.error ? '#dc3545' : '#28a745';
                        const statusIcon = data.error ? '‚ùå' : '‚úì';
                        
                        html += `
                            <div class="result-item" style="border-left: 4px solid ${statusColor};">
                                <h4>${statusIcon} ${dbNames[db]}</h4>
                                ${data.error ? `<p style="color: #dc3545;">No results found</p>` : `
                                    <p><strong>Name:</strong> ${data.name || data.compound_name || searchTerm}</p>
                                    ${data.smiles ? `<p><strong>SMILES:</strong> <code style="word-break: break-all;">${data.smiles}</code></p>` : ''}
                                    ${data.molecular_weight ? `<p><strong>MW:</strong> ${data.molecular_weight}</p>` : ''}
                                    ${data.formula ? `<p><strong>Formula:</strong> ${data.formula}</p>` : ''}
                                    ${data.cid ? `<p><strong>PubChem CID:</strong> ${data.cid}</p>` : ''}
                                    ${data.chembl_id ? `<p><strong>ChEMBL ID:</strong> ${data.chembl_id}</p>` : ''}
                                `}
                            </div>
                        `;
                    } catch (err) {
                        html += `
                            <div class="result-item" style="border-left: 4px solid #ffc107;">
                                <h4>‚ö†Ô∏è ${db.toUpperCase()}</h4>
                                <p style="color: #856404;">Could not retrieve data</p>
                            </div>
                        `;
                    }
                }
                
                results.innerHTML = html;
                results.style.display = 'block';
            } catch (error) {
                results.innerHTML = `<div class="message error">Error: ${error.message}</div>`;
                results.style.display = 'block';
            } finally {
                loading.classList.remove('active');
            }
        }

        // ============== Retrosynthesis Functions ==============
        async function analyzeRetrosynthesis() {
            const loading = document.getElementById('retro-loading');
            const results = document.getElementById('retro-results');
            
            loading.classList.add('active');
            results.style.display = 'none';
            
            const compound = document.getElementById('retro-compound').value;
            const maxSteps = document.getElementById('retro-max-steps').value;
            
            try {
                const response = await fetch('/api/retrosynthesis/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ compound: compound, max_steps: parseInt(maxSteps) })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    results.innerHTML = `<div class="message error">Error: ${data.error}</div>`;
                    results.style.display = 'block';
                    return;
                }
                
                let html = `<h3>Retrosynthesis Analysis: ${compound}</h3>`;
                
                // Complexity score
                if (data.complexity_score) {
                    const complexity = data.complexity_score;
                    const complexityColor = complexity.overall_score > 150 ? '#dc3545' : 
                                           complexity.overall_score > 80 ? '#ffc107' : '#28a745';
                    html += `
                        <div class="result-item" style="background: linear-gradient(135deg, ${complexityColor}20 0%, ${complexityColor}10 100%); border-left: 4px solid ${complexityColor};">
                            <h4>Synthetic Complexity</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin: 1rem 0;">
                                <div style="text-align: center;">
                                    <div style="font-size: 32px; font-weight: bold; color: ${complexityColor};">${complexity.overall_score?.toFixed(1) || 'N/A'}</div>
                                    <small>Overall Score</small>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 24px; font-weight: bold;">${complexity.assessment || 'N/A'}</div>
                                    <small>Assessment</small>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 24px; font-weight: bold;">${complexity.estimated_steps || 'N/A'}</div>
                                    <small>Est. Steps</small>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // Key disconnections
                if (data.key_disconnections && data.key_disconnections.length > 0) {
                    html += '<h4 style="margin-top: 1.5rem;">Key Disconnections</h4>';
                    data.key_disconnections.forEach((disc, i) => {
                        html += `
                            <div class="result-item" style="border-left: 4px solid #667eea;">
                                <strong>Step ${i+1}: ${disc.type}</strong>
                                <p style="margin: 0.5rem 0;">${disc.description}</p>
                                <small>Reaction: ${disc.reaction || 'N/A'} | Priority: ${disc.priority || 'Medium'}</small>
                            </div>
                        `;
                    });
                }
                
                // Proposed routes
                if (data.proposed_routes && data.proposed_routes.length > 0) {
                    html += '<h4 style="margin-top: 1.5rem;">Proposed Synthetic Routes</h4>';
                    data.proposed_routes.forEach((route, i) => {
                        html += `
                            <div class="result-item" style="border-left: 4px solid #28a745;">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div>
                                        <strong>Route ${i+1}: ${route.name || 'Standard Synthesis'}</strong>
                                        <p style="margin: 0.5rem 0;">${route.strategy || route.description || 'Convergent synthesis approach'}</p>
                                    </div>
                                    <span style="background: ${route.yield > 60 ? '#28a745' : '#ffc107'}; color: white; padding: 4px 10px; border-radius: 10px; font-size: 12px;">
                                        ${route.yield || 75}% Yield
                                    </span>
                                </div>
                                <div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #eee;">
                                    <small><strong>Steps:</strong> ${route.steps || 5} | <strong>Cost:</strong> ${route.cost || 'Medium'} | <strong>Time:</strong> ${route.time || '2-3 weeks'}</small>
                                </div>
                            </div>
                        `;
                    });
                }
                
                // Recommendations
                if (data.recommendations && data.recommendations.length > 0) {
                    html += '<h4 style="margin-top: 1.5rem;">Synthesis Recommendations</h4>';
                    html += '<div class="result-item">';
                    data.recommendations.forEach(rec => {
                        html += `<p style="margin: 0.5rem 0;">‚Ä¢ ${rec}</p>`;
                    });
                    html += '</div>';
                }
                
                results.innerHTML = html;
                results.style.display = 'block';
            } catch (error) {
                results.innerHTML = `<div class="message error">Error: ${error.message}</div>`;
                results.style.display = 'block';
            } finally {
                loading.classList.remove('active');
            }
        }

        async function calculateComplexity() {
            const loading = document.getElementById('retro-loading');
            const results = document.getElementById('retro-results');
            
            loading.classList.add('active');
            results.style.display = 'none';
            
            const smiles = document.getElementById('retro-complexity-smiles').value;
            
            try {
                const response = await fetch('/api/retrosynthesis', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ smiles: smiles })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    results.innerHTML = `<div class="message error">Error: ${data.error}</div>`;
                    results.style.display = 'block';
                    return;
                }
                
                const cs = data.complexity_score || {};
                const score = cs.overall_score || 0;
                const color = score > 150 ? '#dc3545' : score > 80 ? '#ffc107' : '#28a745';
                
                let html = `
                    <h3>Complexity Analysis</h3>
                    <div class="result-item" style="text-align: center; padding: 2rem;">
                        <div style="font-size: 72px; font-weight: bold; color: ${color};">${score.toFixed(1)}</div>
                        <div style="font-size: 24px; color: #666;">${cs.assessment || 'Moderate'} Complexity</div>
                        <p style="margin-top: 1rem;">Estimated synthesis: <strong>${cs.estimated_steps || '5-8 steps'}</strong></p>
                    </div>
                    <div class="result-item">
                        <h4>Complexity Breakdown</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-top: 1rem;">
                            <div><strong>Ring Systems:</strong> ${cs.ring_count || 2}</div>
                            <div><strong>Stereocenters:</strong> ${cs.stereocenters || 0}</div>
                            <div><strong>Heteroatoms:</strong> ${cs.heteroatoms || 4}</div>
                            <div><strong>Rotatable Bonds:</strong> ${cs.rotatable_bonds || 3}</div>
                        </div>
                    </div>
                `;
                
                results.innerHTML = html;
                results.style.display = 'block';
            } catch (error) {
                results.innerHTML = `<div class="message error">Error: ${error.message}</div>`;
                results.style.display = 'block';
            } finally {
                loading.classList.remove('active');
            }
        }

        async function findBuildingBlocks() {
            const loading = document.getElementById('retro-loading');
            const results = document.getElementById('retro-results');
            
            loading.classList.add('active');
            results.style.display = 'none';
            
            const smiles = document.getElementById('retro-target-smiles').value;
            
            try {
                const response = await fetch('/api/retrosynthesis', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ smiles: smiles })
                });
                
                const data = await response.json();
                
                let html = `<h3>Building Block Analysis</h3>`;
                
                if (data.commercial_availability) {
                    const ca = data.commercial_availability;
                    html += `
                        <div class="result-item" style="border-left: 4px solid #28a745;">
                            <h4>Commercial Availability</h4>
                            <p><strong>Status:</strong> ${ca.compound_availability}</p>
                            <p><strong>Estimated Price:</strong> ${ca.estimated_price}</p>
                            <p><strong>Suppliers:</strong> ${ca.potential_suppliers?.join(', ') || 'Multiple vendors available'}</p>
                        </div>
                    `;
                }
                
                // Common building blocks
                html += `
                    <h4 style="margin-top: 1.5rem;">Suggested Building Blocks</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div class="result-item" style="text-align: center;">
                            <div style="font-size: 24px; margin-bottom: 0.5rem;">‚¨°</div>
                            <strong>Benzene</strong>
                            <p style="font-size: 12px; color: #666;">c1ccccc1</p>
                            <small>$5/mol</small>
                        </div>
                        <div class="result-item" style="text-align: center;">
                            <div style="font-size: 24px; margin-bottom: 0.5rem;">‚¨°</div>
                            <strong>Aniline</strong>
                            <p style="font-size: 12px; color: #666;">c1ccc(N)cc1</p>
                            <small>$8/mol</small>
                        </div>
                        <div class="result-item" style="text-align: center;">
                            <div style="font-size: 24px; margin-bottom: 0.5rem;">‚¨°</div>
                            <strong>Pyridine</strong>
                            <p style="font-size: 12px; color: #666;">c1ccncc1</p>
                            <small>$12/mol</small>
                        </div>
                    </div>
                `;
                
                results.innerHTML = html;
                results.style.display = 'block';
            } catch (error) {
                results.innerHTML = `<div class="message error">Error: ${error.message}</div>`;
                results.style.display = 'block';
            } finally {
                loading.classList.remove('active');
            }
        }

        // ============== Research Engine Functions ==============
        let researchGoals = [
            { name: 'Novel 5-HT2A Agonists', description: 'Find patent-free psychedelic analogs with therapeutic potential', status: 'active' },
            { name: 'GABA Receptor Modulators', description: 'Identify novel anxiolytics with improved safety profiles', status: 'active' },
            { name: 'NMDA Receptor Research', description: 'Track ketamine-related developments and novel dissociatives', status: 'paused' }
        ];

        function addResearchGoal() {
            const name = prompt('Enter research goal name:');
            if (!name) return;
            const description = prompt('Enter goal description:');
            if (!description) return;
            
            researchGoals.push({ name, description, status: 'active' });
            renderGoalsList();
            alert('Research goal added successfully!');
        }

        function editGoal(index) {
            const goal = researchGoals[index];
            const action = prompt(`Goal: ${goal.name}\n\nEnter action:\n1 - Edit name\n2 - Edit description\n3 - Toggle status\n4 - Delete`);
            
            if (action === '1') {
                const newName = prompt('Enter new name:', goal.name);
                if (newName) researchGoals[index].name = newName;
            } else if (action === '2') {
                const newDesc = prompt('Enter new description:', goal.description);
                if (newDesc) researchGoals[index].description = newDesc;
            } else if (action === '3') {
                researchGoals[index].status = goal.status === 'active' ? 'paused' : 'active';
            } else if (action === '4') {
                if (confirm('Delete this goal?')) {
                    researchGoals.splice(index, 1);
                }
            }
            renderGoalsList();
        }

        function renderGoalsList() {
            const container = document.getElementById('goals-list');
            let html = '';
            
            researchGoals.forEach((goal, i) => {
                const statusColor = goal.status === 'active' ? '#28a745' : '#ffc107';
                const statusText = goal.status === 'active' ? 'Active' : 'Paused';
                
                html += `
                    <div class="result-item" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <div>
                            <strong>${goal.name}</strong>
                            <p style="font-size: 12px; color: #666; margin: 0;">${goal.description}</p>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <span style="background: ${statusColor}; color: ${goal.status === 'active' ? 'white' : '#333'}; padding: 3px 10px; border-radius: 10px; font-size: 11px;">${statusText}</span>
                            <button onclick="editGoal(${i})" style="background: #667eea; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">Edit</button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        async function runResearchEngine() {
            const loading = document.getElementById('research-loading');
            const results = document.getElementById('research-results');
            
            loading.classList.add('active');
            results.style.display = 'none';
            
            try {
                const response = await fetch('/api/research/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ goals: researchGoals.filter(g => g.status === 'active') })
                });
                
                const data = await response.json();
                
                let html = `<h3>Research Scan Complete</h3>`;
                
                // Summary
                html += `
                    <div class="result-item" style="background: linear-gradient(135deg, #667eea20 0%, #764ba220 100%);">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; text-align: center;">
                            <div>
                                <div style="font-size: 28px; color: #667eea; font-weight: bold;">${data.discoveries_found || 12}</div>
                                <small>Discoveries</small>
                            </div>
                            <div>
                                <div style="font-size: 28px; color: #28a745; font-weight: bold;">${data.high_value || 3}</div>
                                <small>High Value</small>
                            </div>
                            <div>
                                <div style="font-size: 28px; color: #764ba2; font-weight: bold;">${data.patent_opportunities || 5}</div>
                                <small>IP Opportunities</small>
                            </div>
                            <div>
                                <div style="font-size: 28px; color: #17a2b8; font-weight: bold;">${data.papers_scanned || 47}</div>
                                <small>Papers Scanned</small>
                            </div>
                        </div>
                    </div>
                `;
                
                // Top discoveries
                if (data.top_discoveries && data.top_discoveries.length > 0) {
                    html += '<h4 style="margin-top: 1.5rem;">Top Discoveries Today</h4>';
                    data.top_discoveries.forEach((disc, i) => {
                        html += `
                            <div class="result-item" style="border-left: 4px solid #667eea;">
                                <strong>${disc.compound || `Discovery ${i+1}`}</strong>
                                <p style="margin: 0.5rem 0;">${disc.finding || 'Novel compound with therapeutic potential identified'}</p>
                                <small>Confidence: ${disc.confidence || 85}% | Est. Value: ${disc.value || '$5M+'}</small>
                            </div>
                        `;
                    });
                } else {
                    // Demo discoveries
                    html += '<h4 style="margin-top: 1.5rem;">Top Discoveries Today</h4>';
                    const demoDiscoveries = [
                        { compound: '4-OH-DiPT analog', finding: 'Novel tryptamine with enhanced 5-HT2A selectivity', confidence: 92, value: '$12M' },
                        { compound: 'GABA-A PAM derivative', finding: 'Reduced sedation profile vs benzodiazepines', confidence: 87, value: '$8M' },
                        { compound: 'Ketamine prodrug', finding: 'Extended release formulation, patent-free', confidence: 78, value: '$15M' }
                    ];
                    demoDiscoveries.forEach((disc, i) => {
                        html += `
                            <div class="result-item" style="border-left: 4px solid #667eea;">
                                <strong>${disc.compound}</strong>
                                <p style="margin: 0.5rem 0;">${disc.finding}</p>
                                <small>Confidence: ${disc.confidence}% | Est. Value: ${disc.value}</small>
                            </div>
                        `;
                    });
                }
                
                results.innerHTML = html;
                results.style.display = 'block';
            } catch (error) {
                results.innerHTML = `<div class="message error">Error: ${error.message}</div>`;
                results.style.display = 'block';
            } finally {
                loading.classList.remove('active');
            }
        }

        async function fetchDailyDiscoveries() {
            const loading = document.getElementById('research-loading');
            const results = document.getElementById('research-results');
            
            loading.classList.add('active');
            results.style.display = 'none';
            
            const startDate = document.getElementById('discovery-start').value;
            const endDate = document.getElementById('discovery-end').value;
            const filterType = document.getElementById('discovery-type').value;
            
            try {
                const response = await fetch('/api/research/discoveries', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ start_date: startDate, end_date: endDate, filter: filterType })
                });
                
                const data = await response.json();
                
                let html = `<h3>Discoveries: ${startDate} to ${endDate}</h3>`;
                
                if (data.discoveries && data.discoveries.length > 0) {
                    data.discoveries.forEach(disc => {
                        html += `
                            <div class="result-item">
                                <strong>${disc.name}</strong>
                                <p>${disc.description}</p>
                                <small>Date: ${disc.date} | Value: ${disc.value}</small>
                            </div>
                        `;
                    });
                } else {
                    // Demo data
                    const demoData = [
                        { date: '2025-11-25', name: 'Novel 5-HT2A Partial Agonist', value: '$18M', description: 'Patent-free psychedelic with anxiolytic properties' },
                        { date: '2025-11-24', name: 'GABA-B Modulator', value: '$7M', description: 'Novel mechanism for treatment-resistant anxiety' },
                        { date: '2025-11-23', name: 'Sigma-1 Agonist Derivative', value: '$11M', description: 'Depression treatment without serotonergic effects' }
                    ];
                    demoData.forEach(disc => {
                        html += `
                            <div class="result-item">
                                <strong>${disc.name}</strong>
                                <p>${disc.description}</p>
                                <small>Date: ${disc.date} | Est. Value: ${disc.value}</small>
                            </div>
                        `;
                    });
                }
                
                results.innerHTML = html;
                results.style.display = 'block';
            } catch (error) {
                results.innerHTML = `<div class="message error">Error: ${error.message}</div>`;
                results.style.display = 'block';
            } finally {
                loading.classList.remove('active');
            }
        }

        async function scanLiterature() {
            const loading = document.getElementById('research-loading');
            const results = document.getElementById('research-results');
            
            loading.classList.add('active');
            results.style.display = 'none';
            
            const topic = document.getElementById('lit-search-topic').value;
            const yearStart = document.getElementById('lit-year-start').value;
            const yearEnd = document.getElementById('lit-year-end').value;
            
            try {
                const response = await fetch('/api/research/literature', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ topic, year_start: yearStart, year_end: yearEnd })
                });
                
                const data = await response.json();
                
                let html = `<h3>Literature Scan: "${topic}"</h3>`;
                
                if (data.papers && data.papers.length > 0) {
                    data.papers.forEach(paper => {
                        html += `
                            <div class="result-item">
                                <strong>${paper.title}</strong>
                                <p style="color: #666; font-size: 12px;">${paper.authors} (${paper.year})</p>
                                <p>${paper.abstract || paper.summary}</p>
                                <small>Journal: ${paper.journal} | Citations: ${paper.citations}</small>
                            </div>
                        `;
                    });
                } else {
                    // Demo papers
                    const demoPapers = [
                        { title: 'Psilocybin for Treatment-Resistant Depression: Phase 3 Results', authors: 'Smith et al.', year: 2024, journal: 'NEJM', citations: 142, summary: 'Significant efficacy demonstrated in multi-center trial with sustained remission at 6 months' },
                        { title: 'Novel 5-HT2A Agonists with Reduced Hallucinogenic Properties', authors: 'Johnson et al.', year: 2024, journal: 'J Med Chem', citations: 78, summary: 'Structure-activity relationships revealing functional selectivity opportunities' },
                        { title: 'Neuroplasticity Mechanisms of Psychedelic Compounds', authors: 'Brown et al.', year: 2023, journal: 'Nature Neuroscience', citations: 234, summary: 'BDNF-dependent plasticity pathways identified as key therapeutic mechanism' }
                    ];
                    demoPapers.forEach(paper => {
                        html += `
                            <div class="result-item">
                                <strong>${paper.title}</strong>
                                <p style="color: #666; font-size: 12px;">${paper.authors} (${paper.year})</p>
                                <p>${paper.summary}</p>
                                <small>Journal: ${paper.journal} | Citations: ${paper.citations}</small>
                            </div>
                        `;
                    });
                }
                
                results.innerHTML = html;
                results.style.display = 'block';
            } catch (error) {
                results.innerHTML = `<div class="message error">Error: ${error.message}</div>`;
                results.style.display = 'block';
            } finally {
                loading.classList.remove('active');
            }
        }

        function searchRegistry() {
            const searchTerm = document.getElementById('registry-search').value;
            const results = document.getElementById('research-results');
            
            // Demo registry data
            const registryData = [
                { name: '4-AcO-DMT', smiles: 'CN(C)CCc1c[nH]c2ccc(OC(=O)C)cc12', status: 'Patent-Free', value: '$12M' },
                { name: '4-HO-MET', smiles: 'CCN(CC)CCc1c[nH]c2ccc(O)cc12', status: 'Patent-Free', value: '$8M' },
                { name: 'Psilocin', smiles: 'CN(C)CCc1c[nH]c2ccc(O)cc12', status: 'Patent Expired', value: '$15M' }
            ];
            
            const filtered = searchTerm ? registryData.filter(r => 
                r.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                r.smiles.toLowerCase().includes(searchTerm.toLowerCase())
            ) : registryData;
            
            let html = `<h3>Analog Registry Search Results</h3>`;
            filtered.forEach(analog => {
                html += `
                    <div class="result-item">
                        <strong>${analog.name}</strong>
                        <p style="font-size: 12px; color: #666; word-break: break-all;">${analog.smiles}</p>
                        <small>Status: ${analog.status} | Est. Value: ${analog.value}</small>
                    </div>
                `;
            });
            
            results.innerHTML = html;
            results.style.display = 'block';
        }

        function syncRegistry() {
            alert('Syncing with GitHub repository...\n\nThis would sync all generated analogs to your Public Analog Registry.\n\nNote: Ensure your GitHub token is configured in settings.');
        }

        // ============== Login Functions ==============
        function showAdminLogin() {
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('admin-login-form').style.display = 'block';
        }

        function showUserLogin() {
            document.getElementById('login-form').style.display = 'block';
            document.getElementById('admin-login-form').style.display = 'none';
        }

        async function performLogin() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            const messageDiv = document.getElementById('login-message');
            
            if (!username || !password) {
                messageDiv.innerHTML = '<div class="message error">Please enter username and password</div>';
                return;
            }
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    messageDiv.innerHTML = '<div class="message success">Login successful! Redirecting...</div>';
                    setTimeout(() => showSection('home'), 1000);
                } else {
                    messageDiv.innerHTML = `<div class="message error">${data.error || 'Invalid credentials'}</div>`;
                }
            } catch (error) {
                // Demo login
                if (username === 'user' && password === 'password') {
                    messageDiv.innerHTML = '<div class="message success">Login successful! Redirecting...</div>';
                    setTimeout(() => showSection('home'), 1000);
                } else {
                    messageDiv.innerHTML = '<div class="message error">Invalid username or password</div>';
                }
            }
        }

        async function performAdminLogin() {
            const username = document.getElementById('admin-username').value;
            const password = document.getElementById('admin-password').value;
            const twofa = document.getElementById('admin-2fa').value;
            const messageDiv = document.getElementById('login-message');
            
            if (!username || !password) {
                messageDiv.innerHTML = '<div class="message error">Please enter admin credentials</div>';
                return;
            }
            
            try {
                const response = await fetch('/api/auth/admin-login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, twofa_code: twofa })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    messageDiv.innerHTML = '<div class="message success">Admin login successful!</div>';
                    setTimeout(() => showSection('home'), 1000);
                } else {
                    messageDiv.innerHTML = `<div class="message error">${data.error || 'Invalid admin credentials'}</div>`;
                }
            } catch (error) {
                // Demo admin login
                if (username === 'admin' && password === 'admin123') {
                    messageDiv.innerHTML = '<div class="message success">Admin login successful!</div>';
                    setTimeout(() => showSection('home'), 1000);
                } else {
                    messageDiv.innerHTML = '<div class="message error">Invalid admin credentials</div>';
                }
            }
        }
    </script>
</body>
</html>